<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/img/favicon.png" />
    <title>AR Aplikace - Kyjov</title> <!-- Upřesněný titulek -->
    <!-- Základní styly a preset -->
    <link rel="stylesheet" href="/css/base.css">
    <!-- Styly pro layout stránky -->
    <link rel="stylesheet" href="/css/layout.css">
    <!-- Styly pro komponenty -->
    <link rel="stylesheet" href="/css/buttons.css">
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/text-block.css">
    <link rel="stylesheet" href="/css/links.css">
    <!-- Styly specifické pro stránky (musí být poslední, aby mohly přepsat obecné) -->
    <link rel="stylesheet" href="/css/pages.css">
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Manifest a ikony -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/img/apple_touch_icon_192x192.png">

    <!-- DŮLEŽITÉ: Definice CURRENT_MUSEUM_ID pro tuto stránku, pokud všechny odkazy patří do jednoho muzea -->
    <!-- Pokud by odkazy vedly do různých muzeí, toto by zde nebylo a spoléhali bychom se jen na data-museum-id u odkazů -->
    <script>
        const CURRENT_MUSEUM_ID_OVERVIEW = "muzeumKyjov"; // Specifické pro tuto přehledovou stránku
    </script>
</head>
<body class="home-page">

    <div class="page-wrapper">

        <header class="app-header">
            <img src="/img/augview.png" alt="Logo AR Aplikace" id="app-logo">
            <h1>Vlastivědné muzeum Kyjov</h1> <!-- Název muzea -->
        </header>

        <main>
            <div class="menu-content">
                <!-- Odkazy nyní obsahují data-museum-id -->
                <a href="/assets/kyjov/terce.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/terce_thumb.png" alt="" class="button-icon">
                    <span class="button-text">střelecké terče</span>
                    <span class="star-display" data-museum-id="muzeumKyjov" data-scene-id="/assets/kyjov/terce.html"></span>
                </a>
                <a href="/assets/kyjov/florian.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/florian_thumb.png" alt="" class="button-icon">
                    <span class="button-text">obraz sv.Floriána</span>
                    <span class="star-display" data-museum-id="muzeumKyjov" data-scene-id="/assets/kyjov/florian.html"></span>
                </a>
                <a href="/assets/kyjov/scena_1.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/obrazy_thumb.png" alt="" class="button-icon">
                    <span class="button-text">obrazy v mezipatře</span>
                    <span class="star-display" data-museum-id="muzeumKyjov" data-scene-id="/assets/kyjov/scena_1.html"></span>
                </a>
                <a href="/assets/kyjov/scena_3.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/vedro_thumb.png" alt="" class="button-icon">
                    <span class="button-text">3D vědro</span>
                    <span class="star-display" data-museum-id="muzeumKyjov" data-scene-id="/assets/kyjov/scena_3.html"></span>
                </a>
                <a href="/assets/kyjov/scena_2.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/hadanky_thumb.png" alt="" class="button-icon">
                    <span class="button-text">Hádanky</span>
                    <span class="star-display" data-museum-id="muzeumKyjov" data-scene-id="/assets/kyjov/scena_2.html"></span>
                </a>
            </div>

            <div class="centered-controls">
                <div class="map-section-minimal">
                    <p class="map-link-wrapper-minimal">
                        <a href="https://www.google.com/maps/search/?api=1&query=t%C5%99.+Palack%C3%A9ho+1373%2F13a%2C+697+01+Kyjov+1" target="_blank" rel="noopener noreferrer" class="map-button-minimal">
                            Zobrazit na mapě
                        </a>
                    </p>
                </div>
                <div class="back-button-container">
                    <a href="/muzea_galerie.html" class="menu-button back-button">
                        Zpět
                    </a>
                </div>
            </div>
        </main>

        <button id="help-button" class="help-icon-button" title="Nápověda">?</button>

        <footer class="app-footer">
            <p>© 2025 Vytvořil Václav Pěnčík</p>
        </footer>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Nápověda</h2>
            <p>
                Vyberte si jednu z dostupných scén pomocí tlačítek v hlavní nabídce.
                Po spuštění scény postupujte podle instrukcí na obrazovce pro zobrazení
                rozšířené reality.
            </p>
            <p>POZOR! Je nutné povolit přístup ke kameře zařízení!</p>
            <h2>Menu Panel</h2>
            <div class="help-items-container">
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/terce_thumb.png" alt="terce" class="inline-icon">
                    <p>Střelecké terče se nacházejí v přízemí (expozice Historie).</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/florian_thumb.png" alt="florian" class="inline-icon">
                    <p>Obraz sv.Floriána se nacházejí v přízemí (expozice Historie / Hasiči).</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/obrazy_thumb.png" alt="obrazy" class="inline-icon">
                    <p>Portrét MUDr.Joklíka a obraz třetihor se nachází na schodišti v mezipatře.</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/vedro_thumb.png" alt="vedro" class="inline-icon">
                    <p>3D vizualizace vědra. Položte na stůl pohlednici a zamiřte na ni. Objeví se 3d objekt, který si můžete prohlédnout ze všech stran.</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/hadanky_thumb.png" alt="hadanky" class="inline-icon">
                    <p>Jedná se o demoverzi hádanek k představení projektu AugView.</p>
                </div>
                <hr>
            </div>
             <h2>Sbírejte hvězdy!</h2>
            <div class="help-items-container">
               <div class="help-item">
                    <img src="/img/stars.png" alt="stars" class="inline-icon">
                    <p>Hvězdy ukazují, jak moc jste zvídaví. Objevují se u tlačítek se scénami.
                       Za zhlédnutí všech scén v jedné kategorii získáte zlatou hvězdu.
                       Pokud si přehrajete alespoň polovinu, dostanete stříbrnou hvězdu.
                       A bronzovou získáte už jen za krátké nahlédnutí.</p>
                     <p>
                      Cílem je nasbírat všechny zlaté hvězdy – to je ta pravá výzva!
                      A když se vám to podaří, čeká vás odměna na recepci.</p>
                </div>
            </div>
            <p>Ujistěte se, že máte dostatek světla a sledujte okolí.</p>
            <p>Aplikace využívá Mind AR / A frame.</p>
            <button id="close-help-button" class="menu-button modal-close-button">Zpět do menu</button>
        </div>
    </div>

    <!-- Načtení gamifikační konfigurace JAKO PRVNÍ z gamifikačních skriptů -->
    <script src="/gamification-config.js"></script>
    <!-- gamification.js zde není nutně potřeba, pokud ho nevyužívá script.js nebo jiná logika na této stránce. -->
    <!-- Skript pro hvězdy níže má vlastní logiku. Pokud ho potřebujete, odkomentujte: -->
    <!-- <script src="/gamification.js"></script> -->

    <!-- Připojení tvého hlavního aplikačního JavaScriptu -->
    <script src="/script.js"></script>

    <!-- OPRAVENÝ Skript pro zobrazení hvězd na této přehledové stránce -->
    <!-- ... (všechno předchozí HTML a skripty) ... -->

    <!-- OPRAVENÝ Skript pro zobrazení hvězd na této přehledové stránce -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("KYJOV.HTML: DOMContentLoaded - Začátek skriptu pro hvězdy.");

            if (typeof MUSEUM_CONFIGS === 'undefined' || typeof APP_STORAGE_KEY === 'undefined') {
                console.error("KYJOV.HTML Chyba: MUSEUM_CONFIGS nebo APP_STORAGE_KEY nejsou definovány.");
                return;
            }
            console.log("KYJOV.HTML: Konfigurace (MUSEUM_CONFIGS, APP_STORAGE_KEY) dostupná.");

            function getStoredAppData_KyjovPage() {
                const rawData = localStorage.getItem(APP_STORAGE_KEY);
                console.log("KYJOV.HTML - getStoredAppData: Surová data z localStorage:", rawData);
                const parsedData = rawData ? JSON.parse(rawData) : {};
                console.log("KYJOV.HTML - getStoredAppData: Parsovaná data:", JSON.parse(JSON.stringify(parsedData))); // Hluboká kopie pro logování
                return parsedData;
            }

            function calculateStarLevelForScene_KyjovPage(sceneProgressData, sceneConfig) {
                console.log("KYJOV.HTML - calculateStarLevel: Vstupní sceneProgressData:", sceneProgressData, "Vstupní sceneConfig:", sceneConfig);
                if (!sceneConfig || typeof sceneConfig.totalMarkers !== 'number' || !Array.isArray(sceneConfig.markers)) {
                    console.warn("KYJOV.HTML - calculateStarLevel: Neplatná konfigurace scény:", sceneConfig);
                    return 'none';
                }

                const activatedMarkersCount = sceneConfig.markers.filter(markerId => sceneProgressData && sceneProgressData[markerId] === true).length;
                const totalMarkersInScene = sceneConfig.totalMarkers;
                console.log("KYJOV.HTML - calculateStarLevel: Pro scénu '" + sceneConfig.name + "': Aktivováno:", activatedMarkersCount, "Celkem:", totalMarkersInScene);


                if (totalMarkersInScene === 0) {
                    console.log("KYJOV.HTML - calculateStarLevel: Úroveň 'none' (totalMarkersInScene je 0)");
                    return 'none';
                }
                if (activatedMarkersCount === 0) {
                    console.log("KYJOV.HTML - calculateStarLevel: Úroveň 'none' (activatedMarkersCount je 0)");
                    return 'none';
                }
                
                let level = 'none';
                if (totalMarkersInScene === 1) {
                    if (activatedMarkersCount === 1) level = 'gold';
                } else if (totalMarkersInScene === 2) {
                    if (activatedMarkersCount === 2) level = 'gold';
                    else if (activatedMarkersCount === 1) level = 'silver';
                } else if (totalMarkersInScene === 3) {
                    if (activatedMarkersCount === 3) level = 'gold';
                    else if (activatedMarkersCount === 2) level = 'silver';
                    else if (activatedMarkersCount === 1) level = 'bronze';
                } else { // 4 a více
                    if (activatedMarkersCount >= totalMarkersInScene) level = 'gold';
                    else if (activatedMarkersCount >= Math.ceil(totalMarkersInScene / 2)) level = 'silver';
                    else if (activatedMarkersCount > 0) level = 'bronze';
                }
                console.log("KYJOV.HTML - calculateStarLevel: Vypočtená úroveň pro '" + sceneConfig.name + "':", level);
                return level;
            }
            
            function displayStarsOnOverview_KyjovPage(starElement, level) {
                console.log("KYJOV.HTML - displayStars: Element:", starElement, "Úroveň:", level);
                if (!starElement) {
                    console.warn("KYJOV.HTML - displayStars: starElement je null!");
                    return;
                }
                let starsHtml = '';
                switch (level) {
                    case 'bronze': starsHtml = '<img src="/img/bronze_star.png" alt="Bronzová hvězda" class="star-image">'; break;
                    case 'silver': starsHtml = '<img src="/img/silver_star.png" alt="Stříbrná hvězda" class="star-image">'; break;
                    case 'gold': starsHtml = '<img src="/img/gold_star.png" alt="Zlatá hvězda" class="star-image">'; break;
                }
                starElement.innerHTML = starsHtml;
                console.log("KYJOV.HTML - displayStars: Nastaveno innerHTML na:", starsHtml, "pro element:", starElement);
                if (starsHtml === '' && level !== 'none') {
                    console.warn("KYJOV.HTML - displayStars: starsHtml je prázdný, i když úroveň není 'none'. Zkontrolujte cesty k obrázkům nebo logiku switche.");
                }
                 if (starsHtml !== '' && starElement.querySelector('img')) {
                    const img = starElement.querySelector('img');
                    img.onload = () => console.log("KYJOV.HTML - displayStars: Obrázek hvězdy načten:", img.src);
                    img.onerror = () => console.error("KYJOV.HTML - displayStars: CHYBA při načítání obrázku hvězdy:", img.src);
                }
            }

            const storedAppData = getStoredAppData_KyjovPage();
            const pageMuseumId = (typeof CURRENT_MUSEUM_ID_OVERVIEW !== 'undefined') ? CURRENT_MUSEUM_ID_OVERVIEW : null;

            if (!pageMuseumId) {
                console.warn("KYJOV.HTML: CURRENT_MUSEUM_ID_OVERVIEW není definováno.");
            }
            
            const starDisplayElements = document.querySelectorAll('.star-display[data-scene-id]');
            console.log("KYJOV.HTML: Nalezeno prvků pro hvězdy:", starDisplayElements.length, starDisplayElements);

            starDisplayElements.forEach((starElement, index) => {
                console.log(`KYJOV.HTML: Zpracovávám starElement ${index + 1}:`, starElement);
                const scenePath = starElement.dataset.sceneId;
                const elementMuseumId = starElement.dataset.museumId || pageMuseumId;
                console.log(`KYJOV.HTML: Element ${index + 1} - scenePath:`, scenePath, "elementMuseumId:", elementMuseumId);


                if (!elementMuseumId || !scenePath) {
                    console.warn(`KYJOV.HTML: Element ${index + 1} - Chybí data-scene-id nebo nelze určit museum-id.`);
                    displayStarsOnOverview_KyjovPage(starElement, 'none');
                    return; // Pokračuj na další element
                }

                let sceneConfig = null;
                if (MUSEUM_CONFIGS[elementMuseumId] && 
                    MUSEUM_CONFIGS[elementMuseumId].sceneConfig && 
                    MUSEUM_CONFIGS[elementMuseumId].sceneConfig[scenePath]) {
                    sceneConfig = MUSEUM_CONFIGS[elementMuseumId].sceneConfig[scenePath];
                    console.log(`KYJOV.HTML: Element ${index + 1} - Nalezena konfigurace scény:`, sceneConfig);
                }

                if (sceneConfig) {
                    const museumProgress = storedAppData[elementMuseumId] || { scenes: {} };
                    const sceneProgress = museumProgress.scenes[scenePath] || {};
                    console.log(`KYJOV.HTML: Element ${index + 1} - museumProgress:`, JSON.parse(JSON.stringify(museumProgress)), "sceneProgress:", JSON.parse(JSON.stringify(sceneProgress)));
                    
                    const level = calculateStarLevelForScene_KyjovPage(sceneProgress, sceneConfig);
                    displayStarsOnOverview_KyjovPage(starElement, level);
                } else {
                    console.warn(`KYJOV.HTML: Element ${index + 1} - Konfigurace pro scénu "${scenePath}" v muzeu "${elementMuseumId}" nenalezena.`);
                    displayStarsOnOverview_KyjovPage(starElement, 'none');
                }
            });
            console.log("KYJOV.HTML: Zobrazení hvězd dokončeno.");
        });
    </script>
