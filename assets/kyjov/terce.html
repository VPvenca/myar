<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <!-- KROK 1: Načtení gamifikačních skriptů -->
    <script src="/gamification-config.js"></script>
    <script src="/gamification.js"></script>
    <style>
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <button id="startButton">Spustit AR</button>

<a href="/assets/kyjov/kyjov.html" style="position: absolute; top: 10px; left: 10px; z-index: 1001; padding: 8px 15px; background-color: rgba(0,0,0,0.5); color: white; text-decoration: none; border-radius: 3px; font-size: 14px;">
    Zpět do Menu
</a>

    <a-scene mindar-image="imageTargetSrc:/assets/kyjov/mind/terce.mind;
        uiLoading: yes; uiError: yes;
        renderer: {colorManagement: true};
        physicallyCorrectLights: true;
        vr-mode-ui: {enabled: false};
        device-orientation-permission-ui: {enabled: false}">

        <a-assets>
        <video id="video1" src="/assets/kyjov/mp4/selim.mp4" preload="auto" loop playsinline></video>
        <video id="video2" src="/assets/kyjov/mp4/terc_1.mp4" preload="auto" loop playsinline></video>
        <video id="video3" src="/assets/kyjov/mp4/terc_2.mp4" preload="auto" loop playsinline></video>
        <video id="video4" src="/assets/kyjov/mp4/terc_3.mp4" preload="auto" loop playsinline></video>
        <audio id="audio1" src="/assets/kyjov/mp3/selim.mp3" preload="auto"></audio>
        <audio id="audio2" src="/assets/kyjov/mp3/terc_1.mp3" preload="auto"></audio>
        <audio id="audio3" src="/assets/kyjov/mp3/terc_2.mp3" preload="auto"></audio>
        <audio id="audio4" src="/assets/kyjov/mp3/terc_3.mp3" preload="auto"></audio>
         </a-assets>


        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- KROK 2: Přidání data-marker-id -->
        <a-entity mindar-image-target="targetIndex: 0" data-marker-id="terc_selim">
            <a-video id="videoEntity1" src="#video1" position="0 0 0" scale="1 1 1" autoplay="false"></a-video>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1" data-marker-id="terc_kyjov_1">
            <a-video id="videoEntity2" src="#video2" position="0 0 0" scale="1 1 1" autoplay="false"></a-video>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 2" data-marker-id="terc_kyjov_2">
            <a-video id="videoEntity3" src="#video3" position="0 0 0" scale="1 1 1" autoplay="false"></a-video>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 3" data-marker-id="terc_kyjov_3">
            <a-video id="videoEntity4" src="#video4" position="0 0 0" scale="1 1 1" autoplay="false"></a-video>
        </a-entity>
    </a-scene>

    <script>
        let audioContext;
        let audioBuffer1, audioBuffer2, audioBuffer3, audioBuffer4; // Zkrácená deklarace

        async function loadAudio(url) {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            return await audioContext.decodeAudioData(arrayBuffer);
        }

        document.getElementById('startButton').addEventListener('click', async function() {
            const video1 = document.getElementById('video1');
            const video2 = document.getElementById('video2');
            const video3 = document.getElementById('video3');
            const video4 = document.getElementById('video4');

            video1.muted = false; video2.muted = false; video3.muted = false; video4.muted = false;

            video1.play().catch(e => console.warn("Video 1 play failed:", e));
            video2.play().catch(e => console.warn("Video 2 play failed:", e));
            video3.play().catch(e => console.warn("Video 3 play failed:", e));
            video4.play().catch(e => console.warn("Video 4 play failed:", e));

            this.style.display = 'none';
            audioContext = new (window.AudioContext || window.webkitAudioContext)();

            try {
                [audioBuffer1, audioBuffer2, audioBuffer3, audioBuffer4] = await Promise.all([
                    loadAudio(document.getElementById('audio1').src),
                    loadAudio(document.getElementById('audio2').src),
                    loadAudio(document.getElementById('audio3').src),
                    loadAudio(document.getElementById('audio4').src)
                ]);
            } catch (error) {
                console.error('Error loading audio:', error);
            }
        });

        const target1 = document.querySelector('[mindar-image-target="targetIndex: 0"]');
        const target2 = document.querySelector('[mindar-image-target="targetIndex: 1"]');
        const target3 = document.querySelector('[mindar-image-target="targetIndex: 2"]');
        const target4 = document.querySelector('[mindar-image-target="targetIndex: 3"]');
        const videoEntity1 = document.getElementById('videoEntity1');
        const videoEntity2 = document.getElementById('videoEntity2');
        const videoEntity3 = document.getElementById('videoEntity3');
        const videoEntity4 = document.getElementById('videoEntity4');

        function playSound(buffer) {
            if (audioContext && buffer) { // Kontrola audioContext
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start();
                return source;
            }
            return null;
        }

        let audioSource1 = null, audioSource2 = null, audioSource3 = null, audioSource4 = null;

        // KROK 3: Integrace gamifikační logiky
        const currentSceneId = getCurrentSceneId();
        let sceneConfigValid = false;

        if (!SCENE_CONFIG || !SCENE_CONFIG[currentSceneId]) {
            console.error("GAMIFICATION ERROR: Scene config not found for this page:", currentSceneId, ". Make sure gamification-config.js is loaded and the path is correct in SCENE_CONFIG.");
        } else {
            sceneConfigValid = true;
        }

        // Helper funkce pro nastavení listenerů (DRY - Don't Repeat Yourself)
        function setupTargetListeners(targetEntity, videoEntity, audioBuffer, audioSourceRef, markerIdNum) {
            if (targetEntity) {
                const markerId = targetEntity.dataset.markerId;
                if (!markerId) {
                    console.warn(`Gamification: Target ${markerIdNum} is missing 'data-marker-id'.`);
                }

                targetEntity.addEventListener('targetFound', () => {
                    console.log(`Target ${markerIdNum} found!`);
                    if (videoEntity.components.material?.material.map?.image) {
                        videoEntity.components.material.material.map.image.play().catch(e => console.warn(`VideoEntity${markerIdNum} play failed`, e));
                    }
                    if (audioContext && audioBuffer && !audioSourceRef.source) { // audioSourceRef je nyní objekt
                        audioSourceRef.source = playSound(audioBuffer);
                    }

                    if (sceneConfigValid && markerId) {
                        console.log("Recording activation for marker:", markerId);
                        recordMarkerActivation(currentSceneId, markerId);
                    }
                });

                targetEntity.addEventListener('targetLost', () => {
                    console.log(`Target ${markerIdNum} lost!`);
                    if (videoEntity.components.material?.material.map?.image) {
                        videoEntity.components.material.material.map.image.pause();
                    }
                    if (audioSourceRef.source) {
                        audioSourceRef.source.stop();
                        audioSourceRef.source = null;
                    }
                });
            } else {
                console.warn(`Target ${markerIdNum} (targetIndex: ${markerIdNum - 1}) not found in DOM.`);
            }
        }

        // Použití helper funkce pro každý target
        // Abychom mohli modifikovat audioSourceX uvnitř funkce, předáme je jako objekt (reference)
        let audioSourceRef1 = { source: audioSource1 };
        let audioSourceRef2 = { source: audioSource2 };
        let audioSourceRef3 = { source: audioSource3 };
        let audioSourceRef4 = { source: audioSource4 };

        setupTargetListeners(target1, videoEntity1, audioBuffer1, audioSourceRef1, 1);
        setupTargetListeners(target2, videoEntity2, audioBuffer2, audioSourceRef2, 2);
        setupTargetListeners(target3, videoEntity3, audioBuffer3, audioSourceRef3, 3);
        setupTargetListeners(target4, videoEntity4, audioBuffer4, audioSourceRef4, 4);

        // Po volání setupTargetListeners, pokud chcete mít přístup k aktuálním audioSourceX:
        // audioSource1 = audioSourceRef1.source; // atd. pokud je to potřeba jinde

    </script>
</body>
</html>
