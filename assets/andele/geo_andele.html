<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- A-Frame a AR.js pro geolokaci -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .back-button-ar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            padding: 8px 15px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 14px;
        }
        
        /* Ovl√°dac√≠ panel pro kameru */
        .camera-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            min-width: 200px;
            border: 2px solid #fff;
        }
        
        .camera-controls h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 3px;
        }
        
        .control-value {
            text-align: center;
            font-size: 11px;
            color: #ccc;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }
        
        .preset-btn {
            padding: 5px 8px;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
        }
        
        .preset-btn:hover {
            background-color: rgba(255,255,255,0.3);
        }
        
        .toggle-controls {
            position: fixed;
            top: 60px;
            right: 10px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }
        
        .geolocation-info {
            position: fixed;
            bottom: 60px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            max-width: 200px;
        }
        
        .distance-info {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            text-align: center;
            border: 2px solid #00ff00;
        }
    </style>
</head>
<body>
    <a href="/assets/andele/andele.html" class="back-button-ar">
        Zpƒõt do Menu
    </a>
    
    <div class="toggle-controls" id="toggleControls">
        ‚öôÔ∏è Nastaven√≠ kamery
    </div>
    
    <!-- Ovl√°dac√≠ panel kamery -->
    <div class="camera-controls" id="cameraControls" style="display: none;">
        <h3>üé• Nastaven√≠ Kamery</h3>
        
        <div class="control-group">
            <label>FOV (Zorn√Ω √∫hel)</label>
            <input type="range" id="fovSlider" min="30" max="120" value="70" step="1">
            <div class="control-value" id="fovValue">70¬∞</div>
        </div>
        
        <div class="control-group">
            <label>Aspect Ratio</label>
            <input type="range" id="aspectSlider" min="0.5" max="2.0" value="1.0" step="0.1">
            <div class="control-value" id="aspectValue">1.0</div>
        </div>
        
        <div class="control-group">
            <label>Near Plane</label>
            <input type="range" id="nearSlider" min="0.01" max="1.0" value="0.1" step="0.01">
            <div class="control-value" id="nearValue">0.1</div>
        </div>
        
        <div class="control-group">
            <label>Far Plane</label>
            <input type="range" id="farSlider" min="100" max="10000" value="1000" step="100">
            <div class="control-value" id="farValue">1000</div>
        </div>
        
        <div class="preset-buttons">
            <button class="preset-btn" onclick="setPreset('phone')">üì± Telefon</button>
            <button class="preset-btn" onclick="setPreset('tablet')">üì≤ Tablet</button>
            <button class="preset-btn" onclick="setPreset('wide')">üì∫ Wide</button>
            <button class="preset-btn" onclick="setPreset('default')">üîÑ Default</button>
        </div>
    </div>
    
    <div class="geolocation-info" id="geoInfo">
        Z√≠sk√°v√°n√≠ polohy...
    </div>
    
    <div class="distance-info" id="distanceInfo">
        üìç Hled√°m nejbli≈æ≈°√≠ bod...
    </div>
    
    <!-- AR sc√©na s geolokac√≠ -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true; precision: medium;"
        device-orientation-permission-ui="enabled: false"
        style="width: 100vw; height: 100vh;">

        <a-assets>
            <img id="marker1" src="/assets/andele/img/andel_1.png">
            <img id="marker2" src="/assets/andele/img/andel_1.png">
            <img id="marker3" src="/assets/andele/img/andel_1.png">
            
            <!-- Audio soubory -->
            <audio id="audio1" src="/assets/andele/mp3/andel_1.mp3" preload="auto"></audio>
            <audio id="audio2" src="/assets/andele/mp3/andel_1.mp3" preload="auto"></audio>
            <audio id="audio3" src="/assets/andele/mp3/andel_1.mp3" preload="auto"></audio>
        </a-assets>

        <!-- Kamera s geolokac√≠ a nastaviteln√Ωmi parametry -->
        <a-camera 
            id="camera"
            gps-camera
            rotation-reader
            camera="fov: 70; aspect: 1.0; near: 0.1; far: 1000;">
        </a-camera>

        <!-- AR objekty na konkr√©tn√≠ch GPS sou≈ôadnic√≠ch -->
        <!-- Angel_1 -->
        <a-entity 
            gps-entity-place="latitude: 49.0091667; longitude: 17.1286111"
            data-marker-id="andel_1"
            data-audio-id="audio1"
            class="ar-object"
            visible="false">
            
            <a-plane 
                src="#marker1" 
                position="0 3 0" 
                scale="4 5 1" 
                rotation="0 130 0"
                material="transparent: true; alphaTest: 0.1; side: double">
            </a-plane>
        </a-entity>

        <!-- Angel_2 -->
        <a-entity 
             gps-entity-place="latitude: 49.0907222; longitude: 17.1329444"
                data-marker-id="andel_2"
                data-audio-id="audio2"
                class="ar-object"
                visible="false">
            
            <a-plane 
                src="#marker2" 
                position="0 3 0" 
                scale="4 5 1" 
                rotation="0 130 0"
                material="transparent: true; alphaTest: 0.1; side: double">
            </a-plane>
        </a-entity>

        <!-- Angel_3 -->
        <a-entity 
             gps-entity-place="latitude: 48.9814167; longitude: 17.1526667"
               data-marker-id="andel_3"
               data-audio-id="audio3"
               class="ar-object"
               visible="false">
            
            <a-plane 
                src="#marker3" 
                position="0 3 0" 
                scale="4 5 1" 
                rotation="0 130 0"
                material="transparent: true; alphaTest: 0.1; side: double">
            </a-plane>
        </a-entity>

    </a-scene>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let userPosition = null;
        let camera = null;
        let currentlyPlayingAudio = null;
        let audioPlayingForMarker = null;
        
        // Konstanty
        const PROXIMITY_THRESHOLD = 50;
        const AR_VISIBILITY_THRESHOLD = 20;
        const AUDIO_THRESHOLD = 10;
        
        // Definice c√≠lov√Ωch bod≈Ø
        const markers = [
            { 
                id: "andel_1", 
                lat: 49.0091667,
                lng: 17.1286111,
                name: "Andƒõl",
                description: "nebesk√Ω Andƒõl",
                audioId: "audio1"
            },
            { 
                 id: "andel_2", 
                 lat: 49.0907222,  
                 lng: 17.1329444,  
                 name: "Andƒõl_2",
                 description: "nebesk√Ω Andƒõl 2",
                 audioId: "audio2"
            },
            { 
                 id: "andel_3", 
                 lat: 48.9814167,  
                 lng: 17.1526667,  
                 name: "Andƒõl_3",
                 description: "nebesk√Ω Andƒõl 3",
                 audioId: "audio3"
            }
        ];

        // Funkce pro aktualizaci kamery
        function updateCamera() {
            if (!camera) return;
            
            const fov = document.getElementById('fovSlider').value;
            const aspect = document.getElementById('aspectSlider').value;
            const near = document.getElementById('nearSlider').value;
            const far = document.getElementById('farSlider').value;
            
            // Aktualizace A-Frame kamery
            camera.setAttribute('camera', {
                fov: parseFloat(fov),
                aspect: parseFloat(aspect),
                near: parseFloat(near),
                far: parseFloat(far)
            });
            
            // Aktualizace zobrazen√Ωch hodnot
            document.getElementById('fovValue').textContent = `${fov}¬∞`;
            document.getElementById('aspectValue').textContent = aspect;
            document.getElementById('nearValue').textContent = near;
            document.getElementById('farValue').textContent = far;
            
            console.log(`Camera updated: FOV=${fov}, Aspect=${aspect}, Near=${near}, Far=${far}`);
        }

        // P≈ôednastaven√© konfigurace
        function setPreset(presetName) {
            const presets = {
                'phone': { fov: 75, aspect: 0.6, near: 0.1, far: 1000 },
                'tablet': { fov: 70, aspect: 1.3, near: 0.1, far: 1000 },
                'wide': { fov: 90, aspect: 1.8, near: 0.1, far: 1000 },
                'default': { fov: 70, aspect: 1.0, near: 0.1, far: 1000 }
            };
            
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('fovSlider').value = preset.fov;
                document.getElementById('aspectSlider').value = preset.aspect;
                document.getElementById('nearSlider').value = preset.near;
                document.getElementById('farSlider').value = preset.far;
                updateCamera();
            }
        }

        // Automatick√© urƒçen√≠ aspect ratio podle rozmƒõr≈Ø obrazovky
        function getScreenAspectRatio() {
            return window.innerWidth / window.innerHeight;
        }

        // Optimalizace pro mobiln√≠ za≈ô√≠zen√≠
        function optimizeForMobile() {
            const aspectRatio = getScreenAspectRatio();
            const isPortrait = aspectRatio < 1.0;
            
            if (isPortrait) {
                // Portr√©tn√≠ orientace - adjustace pro vysok√© telefony
                document.getElementById('fovSlider').value = 75;
                document.getElementById('aspectSlider').value = Math.min(aspectRatio * 1.2, 1.0);
            } else {
                // Landscape orientace
                document.getElementById('fovSlider').value = 85;
                document.getElementById('aspectSlider').value = Math.min(aspectRatio * 0.8, 1.5);
            }
            
            updateCamera();
        }

        // Setup event listener≈Ø pro ovl√°dac√≠ prvky
        function setupCameraControls() {
            // Slidery
            document.getElementById('fovSlider').addEventListener('input', updateCamera);
            document.getElementById('aspectSlider').addEventListener('input', updateCamera);
            document.getElementById('nearSlider').addEventListener('input', updateCamera);
            document.getElementById('farSlider').addEventListener('input', updateCamera);
            
            // Toggle pro zobrazen√≠/skryt√≠ ovl√°d√°n√≠
            document.getElementById('toggleControls').addEventListener('click', () => {
                const controls = document.getElementById('cameraControls');
                controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
            });
            
            // Automatick√° optimalizace p≈ôi zmƒõnƒõ orientace
            window.addEventListener('orientationchange', () => {
                setTimeout(optimizeForMobile, 500); // ƒåek√°n√≠ na dokonƒçen√≠ rotace
            });
            
            // Kl√°vesov√© zkratky pro rychl√© nastaven√≠
            document.addEventListener('keydown', (event) => {
                switch(event.key) {
                    case '1': setPreset('phone'); break;
                    case '2': setPreset('tablet'); break;
                    case '3': setPreset('wide'); break;
                    case '0': setPreset('default'); break;
                    case 'c': 
                        const controls = document.getElementById('cameraControls');
                        controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
                        break;
                }
            });
        }

        // V√Ωpoƒçet vzd√°lenosti
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Nalezen√≠ nejbli≈æ≈°√≠ho markeru
        function findClosestMarker() {
            if (!userPosition) return null;
            
            let closest = null;
            let minDistance = Infinity;
            
            markers.forEach(marker => {
                const distance = calculateDistance(
                    userPosition.lat, userPosition.lng,
                    marker.lat, marker.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closest = { ...marker, distance };
                }
            });
            
            return closest;
        }

        // Aktualizace zobrazen√≠ vzd√°lenosti
        function updateDistanceDisplay() {
            const distanceInfo = document.getElementById('distanceInfo');
            const targetMarker = findClosestMarker();
            
            if (targetMarker) {
                const distance = Math.round(targetMarker.distance);
                distanceInfo.innerHTML = `üìç ${targetMarker.name}<br><strong>${distance}m</strong>`;
                
                // Zmƒõna barvy podle vzd√°lenosti
                if (distance <= AR_VISIBILITY_THRESHOLD) {
                    distanceInfo.style.borderColor = '#00ff00';
                    distanceInfo.style.backgroundColor = 'rgba(0,255,0,0.8)';
                } else if (distance <= PROXIMITY_THRESHOLD) {
                    distanceInfo.style.borderColor = '#88ff00';
                    distanceInfo.style.backgroundColor = 'rgba(136,255,0,0.8)';
                } else if (distance <= 100) {
                    distanceInfo.style.borderColor = '#ffaa00';
                    distanceInfo.style.backgroundColor = 'rgba(255,170,0,0.8)';
                } else {
                    distanceInfo.style.borderColor = '#ff0000';
                    distanceInfo.style.backgroundColor = 'rgba(255,0,0,0.8)';
                }
            }
        }

        // Z√≠sk√°n√≠ aktu√°ln√≠ polohy
        function getCurrentPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        document.getElementById('geoInfo').innerHTML = 
                            `Poloha: ${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}<br>
                             P≈ôesnost: ${userPosition.accuracy.toFixed(0)}m`;
                        
                        checkProximityToMarkers();
                        updateDistanceDisplay();
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        document.getElementById('geoInfo').innerHTML = 
                            `Chyba geolokace: ${error.message}`;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }
        }

        // Kontrola bl√≠zkosti k marker≈Øm
        function checkProximityToMarkers() {
            if (!userPosition) return;
            
            markers.forEach(marker => {
                const distance = calculateDistance(
                    userPosition.lat, userPosition.lng,
                    marker.lat, marker.lng
                );
                
                const arEntity = document.querySelector(`[data-marker-id="${marker.id}"]`);
                if (arEntity) {
                    if (distance <= AR_VISIBILITY_THRESHOLD) {
                        arEntity.setAttribute('visible', 'true');
                        console.log(`AR object visible for ${marker.id} at distance ${distance.toFixed(2)}m`);
                    } else {
                        arEntity.setAttribute('visible', 'false');
                    }
                }
            });
        }

        // Sledov√°n√≠ polohy
        function watchPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        document.getElementById('geoInfo').innerHTML = 
                            `Poloha: ${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}<br>
                             P≈ôesnost: ${userPosition.accuracy.toFixed(0)}m`;
                        
                        checkProximityToMarkers();
                        updateDistanceDisplay();
                    },
                    (error) => {
                        console.error("Geolocation watch error:", error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 30000
                    }
                );
            }
        }

        // Inicializace
        window.addEventListener('load', () => {
            console.log("Starting geolocation AR scene with camera controls...");
            
            // Z√≠sk√°n√≠ reference na kameru
            camera = document.getElementById('camera');
            
            // Setup ovl√°dac√≠ch prvk≈Ø
            setupCameraControls();
            
            // Automatick√° optimalizace pro mobiln√≠ za≈ô√≠zen√≠
            optimizeForMobile();
            
            // Spu≈°tƒõn√≠ geolokace
            getCurrentPosition();
            watchPosition();
        });

        // A-Frame sc√©na je p≈ôipravena
        document.querySelector('a-scene').addEventListener('loaded', () => {
            console.log("A-Frame scene loaded with camera controls");
            camera = document.getElementById('camera');
            updateCamera(); // Aplikovat nastaven√≠ po naƒçten√≠ sc√©ny
        });
    </script>
</body>
</html>