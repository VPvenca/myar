<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
         /* Skrytí výchozího UI MindAR, pokud používáte vlastní tlačítko */
        .mindar-ui-overlay .mindar-ui-scanning,
        .mindar-ui-overlay .mindar-ui-loading {
             display: none !important;
        }
    </style>
</head>
<body>
    <button id="startButton">Spustit AR</button>

    <a href="/assets/kyjov/kyjov.html" style="position: absolute; top: 10px; left: 10px; z-index: 1001; padding: 8px 15px; background-color: rgba(0,0,0,0.5); color: white; text-decoration: none; border-radius: 3px; font-size: 14px;">
        Zpět do Menu
    </a>

    <!-- Zkontrolujte cestu k .mind souboru! Musí obsahovat 5 cílů. -->
    <!-- Přidáno maxTrack: 5 -->
    <a-scene mindar-image="imageTargetSrc:/assets/kyjov/mind/kyjov.mind;
        maxTrack: 5; /* Povolí sledování až 5 cílů současně (i když přehráváme jen jeden) */
        uiLoading: no; /* Skryto, protože máme vlastní tlačítko */
        uiError: yes;
        renderer: {colorManagement: true};
        physicallyCorrectLights: true;
        vr-mode-ui: {enabled: false};
        device-orientation-permission-ui: {enabled: false}">

        <a-assets>
            <!-- Cíl 0 -->
            <video id="video1" src="/assets/kyjov/mp4/selim.mp4" preload="auto" loop playsinline webkit-playsinline muted crossOrigin="anonymous"></video>
            <audio id="audio1" src="/assets/kyjov/mp3/selim.mp3" preload="auto" crossOrigin="anonymous"></audio>

            <!-- Cíl 1 -->
            <video id="video2" src="/assets/kyjov/mp4/terc_1.mp4" preload="auto" loop playsinline webkit-playsinline muted crossOrigin="anonymous"></video>
            <audio id="audio2" src="/assets/kyjov/mp3/terc_1.mp3" preload="auto" crossOrigin="anonymous"></audio>

            <!-- Cíl 2 -->
            <!-- !!! NAHRAĎTE NÁZVY SOUBORŮ !!! -->
            <video id="video3" src="/assets/kyjov/mp4/terc_2.mp4" preload="auto" loop playsinline webkit-playsinline muted crossOrigin="anonymous"></video>
            <audio id="audio3" src="/assets/kyjov/mp3/terc_2.mp3" preload="auto" crossOrigin="anonymous"></audio>

            <!-- Cíl 3 -->
            <!-- !!! NAHRAĎTE NÁZVY SOUBORŮ !!! -->
            <video id="video4" src="/assets/kyjov/mp4/terc_3.mp4" preload="auto" loop playsinline webkit-playsinline muted crossOrigin="anonymous"></video>
            <audio id="audio4" src="/assets/kyjov/mp3/terc_3.mp3" preload="auto" crossOrigin="anonymous"></audio>

            <!-- Cíl 4 -->
            <!-- !!! NAHRAĎTE NÁZVY SOUBORŮ !!! -->
            <video id="video5" src="/assets/kyjov/mp4/florian.mp4" preload="auto" loop playsinline webkit-playsinline muted crossOrigin="anonymous"></video>
            <audio id="audio5" src="/assets/kyjov/mp3/florian.mp3" preload="auto" crossOrigin="anonymous"></audio>

        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- Cíl 0 -->
        <a-entity mindar-image-target="targetIndex: 0">
            <!-- Pozor: `autoplay="false"` je ignorováno, A-Frame video se snaží hrát, proto je nutné `muted` v assetech -->
            <!-- width/height/scale upravte podle potřeby -->
            <a-video id="videoEntity1" src="#video1" position="0 0 0" scale="1 1 1" width="1" height="1" ></a-video>
        </a-entity>

        <!-- Cíl 1 -->
        <a-entity mindar-image-target="targetIndex: 1">
            <a-video id="videoEntity2" src="#video2" position="0 0 0" scale="1 1 1" width="1" height="1" ></a-video>
        </a-entity>

        <!-- Cíl 2 -->
        <a-entity mindar-image-target="targetIndex: 2">
             <!-- Unikátní ID entity -->
            <a-video id="videoEntity3" src="#video3" position="0 0 0" scale="1 1 1" width="1" height="1" ></a-video>
        </a-entity>

        <!-- Cíl 3 -->
        <a-entity mindar-image-target="targetIndex: 3">
            <a-video id="videoEntity4" src="#video4" position="0 0 0" scale="1 1 1" width="1" height="0.56" ></a-video>
        </a-entity>

        <!-- Cíl 4 -->
        <a-entity mindar-image-target="targetIndex: 4">
            <a-video id="videoEntity5" src="#video5" position="0 0 0" scale="1 1 1" width="1" height="1.2" ></a-video>
        </a-entity>

    </a-scene>

    <script>
        let audioContext;
        // Proměnné pro audio buffery
        let audioBuffer1, audioBuffer2, audioBuffer3, audioBuffer4, audioBuffer5;
        // Proměnné pro aktivní audio zdroje
        let audioSource1 = null;
        let audioSource2 = null;
        let audioSource3 = null;
        let audioSource4 = null;
        let audioSource5 = null;

        // Funkce pro dekódování audio dat (beze změny)
        async function loadAudio(url) {
             // Zajistíme existenci AudioContextu před dekódováním
             if (!audioContext) {
                 console.error("AudioContext not initialized before loading audio:", url);
                 return null; // Nebo vyvolat chybu
             }
            console.log(`Attempting to load audio: ${url}`);
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                console.log(`Audio loaded successfully: ${url}`);
                return decodedBuffer;
            } catch (error) {
                console.error(`Error loading or decoding audio ${url}:`, error);
                return null; // Vrací null při chybě
            }
        }

        // Funkce pro přehrání zvuku (přebírá buffer a referenci na source proměnnou)
        // Vrací novou instanci source, která se uloží do globální proměnné
        function playSound(buffer) {
            if (!audioContext || audioContext.state !== 'running') {
                 console.warn("Cannot play sound, AudioContext not running.");
                 return null;
            }
            if (buffer) {
                try {
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start();
                    // POZNÁMKA: Neukládáme source zde, ale v event listeneru!
                    return source; // Vrátíme instanci pro uložení
                } catch (e) {
                     console.error("Error creating or starting audio source:", e);
                     return null;
                }
            }
            console.log("PlaySound called with null buffer.");
            return null;
        }

        // Funkce pro zastavení zvuku (přebírá referenci na source proměnnou)
        function stopSound(audioSourceRef) {
            if (audioSourceRef) {
                try {
                    audioSourceRef.stop();
                } catch (e) { /* Ignorovat chybu, pokud už je zastaveno */ }
                // POZNÁMKA: Resetování na null se děje v event listeneru!
            }
        }

        // Listener na tlačítko Start
        document.getElementById('startButton').addEventListener('click', async function() {
            console.log("Start button clicked. Initializing...");
            this.style.display = 'none'; // Skryjeme tlačítko

            // --- Inicializace AudioContext ---
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                     // Důležité pro Safari a Chrome po interakci uživatele
                     if (audioContext.state === 'suspended') {
                         await audioContext.resume();
                         console.log("AudioContext resumed.");
                     }
                     console.log("AudioContext initialized successfully. State:", audioContext.state);
                } catch (e) {
                    console.error("Failed to initialize AudioContext:", e);
                    alert("Nelze inicializovat zvukový systém. Zvuk nebude fungovat.");
                    // Můžeme zde buď skončit, nebo pokračovat bez zvuku
                }
            }

            // --- Příprava (odemčení) videí ---
            // HACK: Krátké play/pause může pomoci odemknout videa pro pozdější přehrávání
            // Poznámka: Toto *není* ideální řešení, lepší je spouštět videa až v targetFound
             const videoElements = [];
             for (let i = 1; i <= 5; i++) {
                 const video = document.getElementById(`video${i}`);
                 if (video) {
                     video.muted = true; // Důležité - musí být ztlumené pro autoplay programově
                     try {
                         await video.play();
                         video.pause();
                         console.log(`Video ${i} pre-played/paused.`);
                     } catch (e) {
                          console.warn(`Could not pre-play video ${i}. Playback might be blocked later. Error:`, e);
                     }
                 } else {
                      console.warn(`Video element video${i} not found.`);
                 }
             }

            // --- Načtení všech audio bufferů ---
            if (audioContext && audioContext.state === 'running') {
                console.log("Loading audio buffers...");
                try {
                    // Použijeme Promise.all pro paralelní načítání
                    [audioBuffer1, audioBuffer2, audioBuffer3, audioBuffer4, audioBuffer5] = await Promise.all([
                        loadAudio(document.getElementById('audio1').src),
                        loadAudio(document.getElementById('audio2').src),
                        loadAudio(document.getElementById('audio3').src), // Přidáno
                        loadAudio(document.getElementById('audio4').src), // Přidáno
                        loadAudio(document.getElementById('audio5').src)  // Přidáno
                    ]);
                    console.log("All audio buffers loading initiated.");
                     // Můžeme zde přidat kontrolu, zda se všechny buffery načetly (nejsou null)
                } catch (error) {
                    // Chyba v Promise.all (i když loadAudio chyby loguje samo)
                    console.error('Error loading one or more audio buffers:', error);
                }
            } else {
                console.warn("AudioContext not running, skipping audio buffer loading.");
            }

            console.log("Initialization complete.");
        });

        // --- Získání referencí na A-Frame entity ---
        // Poznámka: Je bezpečnější je získat až po načtení scény, ale pro tento styl kódu je necháme zde.
        const target1 = document.querySelector('[mindar-image-target="targetIndex: 0"]');
        const target2 = document.querySelector('[mindar-image-target="targetIndex: 1"]');
        const target3 = document.querySelector('[mindar-image-target="targetIndex: 2"]'); // Přidáno
        const target4 = document.querySelector('[mindar-image-target="targetIndex: 3"]'); // Přidáno
        const target5 = document.querySelector('[mindar-image-target="targetIndex: 4"]'); // Přidáno

        const videoEntity1 = document.getElementById('videoEntity1');
        const videoEntity2 = document.getElementById('videoEntity2');
        const videoEntity3 = document.getElementById('videoEntity3'); // Přidáno
        const videoEntity4 = document.getElementById('videoEntity4'); // Přidáno
        const videoEntity5 = document.getElementById('videoEntity5'); // Přidáno


        // --- Event Listenery pro Cíl 0 ---
        if (target1 && videoEntity1) {
            target1.addEventListener('targetFound', () => {
                console.log("targetFound 0");
                // Přehrát video pomocí A-Frame komponenty
                videoEntity1.components.material?.material?.map?.image?.play().catch(e=>console.error("Video 1 play error", e));
                // Zastavit ostatní zvuky (volitelné, pokud má hrát jen jeden zvuk)
                // stopSound(audioSource2); stopSound(audioSource3); ...
                // Přehrát zvuk, pokud je buffer načten a zvuk nehraje
                if (audioBuffer1 && !audioSource1) {
                    audioSource1 = playSound(audioBuffer1);
                    if (audioSource1) audioSource1.onended = () => { audioSource1 = null; }; // Reset po dohrání
                }
            });

            target1.addEventListener('targetLost', () => {
                console.log("targetLost 0");
                videoEntity1.components.material?.material?.map?.image?.pause();
                // Zastavit zvuk
                if (audioSource1) {
                    stopSound(audioSource1);
                    audioSource1 = null; // Resetovat referenci
                }
            });
        } else { console.warn("Target 0 or VideoEntity 1 not found"); }

        // --- Event Listenery pro Cíl 1 ---
        if (target2 && videoEntity2) {
            target2.addEventListener('targetFound', () => {
                console.log("targetFound 1");
                videoEntity2.components.material?.material?.map?.image?.play().catch(e=>console.error("Video 2 play error", e));
                if (audioBuffer2 && !audioSource2) {
                    audioSource2 = playSound(audioBuffer2);
                    if (audioSource2) audioSource2.onended = () => { audioSource2 = null; };
                }
            });

            target2.addEventListener('targetLost', () => {
                console.log("targetLost 1");
                videoEntity2.components.material?.material?.map?.image?.pause();
                if (audioSource2) {
                    stopSound(audioSource2);
                    audioSource2 = null;
                }
            });
        } else { console.warn("Target 1 or VideoEntity 2 not found"); }

        // --- Event Listenery pro Cíl 2 ---
        if (target3 && videoEntity3) {
            target3.addEventListener('targetFound', () => {
                console.log("targetFound 2"); // Index 2
                videoEntity3.components.material?.material?.map?.image?.play().catch(e=>console.error("Video 3 play error", e));
                if (audioBuffer3 && !audioSource3) {
                    audioSource3 = playSound(audioBuffer3);
                    if (audioSource3) audioSource3.onended = () => { audioSource3 = null; };
                }
            });

            target3.addEventListener('targetLost', () => {
                console.log("targetLost 2"); // Index 2
                videoEntity3.components.material?.material?.map?.image?.pause();
                if (audioSource3) {
                    stopSound(audioSource3);
                    audioSource3 = null;
                }
            });
        } else { console.warn("Target 2 or VideoEntity 3 not found"); }

        // --- Event Listenery pro Cíl 3 ---
        if (target4 && videoEntity4) {
            target4.addEventListener('targetFound', () => {
                console.log("targetFound 3"); // Index 3
                videoEntity4.components.material?.material?.map?.image?.play().catch(e=>console.error("Video 4 play error", e));
                if (audioBuffer4 && !audioSource4) {
                    audioSource4 = playSound(audioBuffer4);
                    if (audioSource4) audioSource4.onended = () => { audioSource4 = null; };
                }
            });

            target4.addEventListener('targetLost', () => {
                console.log("targetLost 3"); // Index 3
                videoEntity4.components.material?.material?.map?.image?.pause();
                if (audioSource4) {
                    stopSound(audioSource4);
                    audioSource4 = null;
                }
            });
        } else { console.warn("Target 3 or VideoEntity 4 not found"); }

        // --- Event Listenery pro Cíl 4 ---
        if (target5 && videoEntity5) {
            target5.addEventListener('targetFound', () => {
                console.log("targetFound 4"); // Index 4
                videoEntity5.components.material?.material?.map?.image?.play().catch(e=>console.error("Video 5 play error", e));
                if (audioBuffer5 && !audioSource5) {
                    audioSource5 = playSound(audioBuffer5);
                    if (audioSource5) audioSource5.onended = () => { audioSource5 = null; };
                }
            });

            target5.addEventListener('targetLost', () => {
                console.log("targetLost 4"); // Index 4
                videoEntity5.components.material?.material?.map?.image?.pause();
                if (audioSource5) {
                    stopSound(audioSource5);
                    audioSource5 = null;
                }
            });
        } else { console.warn("Target 4 or VideoEntity 5 not found"); }

    </script>
</body>
</html>
