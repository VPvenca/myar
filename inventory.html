<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invent√°≈ô √öspƒõch≈Ø</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/inventory.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="inventory-page">

    <div class="page-wrapper">
        <header class="app-header">
            <img src="img/augview.png" alt="Logo AR Aplikace" id="app-logo">
            <h1>Invent√°≈ô √öspƒõch≈Ø</h1>
        </header>

        <main>
            <!-- Progress Overview -->
            <div class="progress-overview">
                <div class="progress-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="total-achievements">0</span>
                        <span class="stat-label">Celkem √∫spƒõch≈Ø</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="unlocked-achievements">0</span>
                        <span class="stat-label">Odemƒçeno</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completion-percentage">0%</span>
                        <span class="stat-label">Dokonƒçeno</span>
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="category-filter" id="categoryFilter">
                <button class="filter-btn active" data-category="all">V≈°echny</button>
                <!-- Kategorie se naƒçtou dynamicky -->
            </div>

            <!-- Achievements Grid -->
            <div class="achievements-container">
                <div id="achievements-grid" class="achievements-grid">
                    <!-- Achievements will be dynamically loaded here -->
                </div>
            </div>

            <!-- Back Button -->
            <div class="back-button-container">
                <a href="index.html" class="menu-button back-button">Zpƒõt na Menu</a>
            </div>
        </main>

        <footer class="app-footer">
            <p>¬© 2025 Vytvo≈ôil V√°clav Pƒõnƒç√≠k</p>
        </footer>
    </div>

    <!-- Achievement Detail Modal -->
    <div id="achievementModal" class="achievement-modal-overlay">
        <div class="achievement-modal-content">
            <span id="achievementModalCloseBtn" class="achievement-modal-close-button">√ó</span>
            <div class="achievement-detail">
                <div class="achievement-icon-large" id="modalAchievementIcon">üèÜ</div>
                <h2 id="modalAchievementName">N√°zev √∫spƒõchu</h2>
                <p id="modalAchievementDescription">Popis √∫spƒõchu</p>
                <div class="achievement-meta">
                    <span class="achievement-rarity" id="modalAchievementRarity">Bƒõ≈æn√Ω</span>
                    <span class="achievement-category" id="modalAchievementCategory">Kategorie</span>
                </div>
                <div class="achievement-unlock-date" id="modalUnlockDate" style="display: none;">
                    <small>Odemƒçeno: <span id="modalUnlockDateText"></span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel (m≈Ø≈æete skr√Ωt v produkci) -->
    <div id="debugPanel" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 11px; max-width: 300px; z-index: 9999;">
        <h4>üêõ Debug Info</h4>
        <div>Gamification loaded: <span id="debugGamificationLoaded">‚ùå</span></div>
        <div>Expositions: <span id="debugExpositions">0</span></div>
        <div>Total achievements: <span id="debugTotalAchievements">0</span></div>
        <div>Categories: <span id="debugCategories">0</span></div>
        <div>Unlocked: <span id="debugUnlocked">0</span></div>
    </div>

    <!-- Load scripts v spr√°vn√©m po≈ôad√≠ -->
    <script src="gamification-config.js"></script>
    <script src="game/kyjov-config.js"></script>
    <script src="game/andele-config.js"></script>
    <script src="game/bohuslavice_stezka_config.js"></script>
    <script src="gamification.js"></script>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let gamificationInitialized = false;
        let currentFilter = 'all';

        // Debug funkce
        function updateDebugInfo() {
            document.getElementById('debugGamificationLoaded').textContent = gamificationInitialized ? '‚úÖ' : '‚ùå';
            document.getElementById('debugExpositions').textContent = Object.keys(EXPOSITION_REGISTRY || {}).length;
            document.getElementById('debugTotalAchievements').textContent = Object.keys(ACHIEVEMENTS_CONFIG || {}).length;
            document.getElementById('debugCategories').textContent = Object.keys(ACHIEVEMENT_CATEGORIES || {}).length;
            
            if (typeof getUnlockedAchievements === 'function') {
                document.getElementById('debugUnlocked').textContent = getUnlockedAchievements().length;
            }
        }

        // Funkce pro inicializaci gamifikaƒçn√≠ho syst√©mu
        function initializeGamificationSystem() {
            console.log("üéÆ Initializing gamification system for inventory...");
            
            // Zavolej inicializaci expoziƒçn√≠ho syst√©mu
            if (typeof initializeExpositions === 'function') {
                initializeExpositions();
                console.log("‚úÖ Exposition system initialized");
            } else {
                console.error("‚ùå initializeExpositions function not found");
                return false;
            }

            // Zkontroluj, zda je v≈°e naƒçteno
            if (!ACHIEVEMENTS_CONFIG || Object.keys(ACHIEVEMENTS_CONFIG).length === 0) {
                console.error("‚ùå ACHIEVEMENTS_CONFIG is empty or not loaded");
                return false;
            }

            if (!ACHIEVEMENT_CATEGORIES || Object.keys(ACHIEVEMENT_CATEGORIES).length === 0) {
                console.error("‚ùå ACHIEVEMENT_CATEGORIES is empty or not loaded");
                return false;
            }

            console.log("‚úÖ Gamification system ready");
            console.log(`üìä Loaded ${Object.keys(ACHIEVEMENTS_CONFIG).length} achievements`);
            console.log(`üìã Loaded ${Object.keys(ACHIEVEMENT_CATEGORIES).length} categories`);
            
            gamificationInitialized = true;
            return true;
        }

        // Hlavn√≠ funkce pro inicializaci invent√°≈ôe
        function initializeInventory() {
            console.log("üì¶ Initializing inventory...");
            
            if (!gamificationInitialized) {
                console.error("‚ùå Gamification system not initialized");
                const grid = document.getElementById('achievements-grid');
                grid.innerHTML = '<div class="no-achievements">‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ gamifikaƒçn√≠ho syst√©mu</div>';
                return;
            }

            loadCategories();
            loadAchievements();
            updateProgressStats();
            updateDebugInfo();
        }

        // Funkce pro naƒçten√≠ kategori√≠
        function loadCategories() {
            const filterContainer = document.getElementById('categoryFilter');
            
            // Odstra≈à existuj√≠c√≠ kategorie (kromƒõ "V≈°echny")
            const existingButtons = filterContainer.querySelectorAll('[data-category]:not([data-category="all"])');
            existingButtons.forEach(btn => btn.remove());

            // P≈ôidej kategorie
            Object.keys(ACHIEVEMENT_CATEGORIES).forEach(categoryId => {
                const category = ACHIEVEMENT_CATEGORIES[categoryId];
                
                // Spoƒç√≠tej kolik achievement≈Ø m√° tato kategorie
                const categoryAchievements = Object.keys(ACHIEVEMENTS_CONFIG).filter(id => 
                    ACHIEVEMENTS_CONFIG[id].category === categoryId
                );
                
                if (categoryAchievements.length === 0) return; // P≈ôeskoƒç pr√°zdn√© kategorie

                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.dataset.category = categoryId;
                button.innerHTML = `${category.icon || ''} ${category.name} (${categoryAchievements.length})`;
                
                filterContainer.appendChild(button);
            });
        }

        function loadAchievements(filterCategory = 'all') {
            console.log(`üìã Loading achievements for category: ${filterCategory}`);
            
            const achievementsGrid = document.getElementById('achievements-grid');
            achievementsGrid.innerHTML = '';

            if (!ACHIEVEMENTS_CONFIG || typeof getUnlockedAchievements !== 'function') {
                achievementsGrid.innerHTML = '<div class="no-achievements">‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ achievement≈Ø</div>';
                return;
            }

            const unlockedAchievements = getUnlockedAchievements();
            const unlockedIds = unlockedAchievements.map(a => a.id);

            // Get all achievements based on filter
            let achievementsToShow = [];
            
            if (filterCategory === 'all') {
                achievementsToShow = Object.keys(ACHIEVEMENTS_CONFIG);
            } else {
                achievementsToShow = Object.keys(ACHIEVEMENTS_CONFIG).filter(id => 
                    ACHIEVEMENTS_CONFIG[id].category === filterCategory
                );
            }

            console.log(`üìä Found ${achievementsToShow.length} achievements for category ${filterCategory}`);

            // Sort achievements: unlocked first, then by rarity
            achievementsToShow.sort((a, b) => {
                const aUnlocked = unlockedIds.includes(a);
                const bUnlocked = unlockedIds.includes(b);
                
                if (aUnlocked && !bUnlocked) return -1;
                if (!aUnlocked && bUnlocked) return 1;
                
                // If both same unlock status, sort by rarity
                const rarityOrder = { legendary: 0, rare: 1, uncommon: 2, common: 3 };
                const aRarity = rarityOrder[ACHIEVEMENTS_CONFIG[a].rarity] || 4;
                const bRarity = rarityOrder[ACHIEVEMENTS_CONFIG[b].rarity] || 4;
                
                return aRarity - bRarity;
            });

            let visibleAchievements = 0;

            achievementsToShow.forEach(achievementId => {
                const achievement = ACHIEVEMENTS_CONFIG[achievementId];
                const isUnlocked = unlockedIds.includes(achievementId);
                const isHidden = achievement.hidden && !isUnlocked;

                // Skip hidden achievements if not unlocked
                if (isHidden) {
                    console.log(`üîí Skipping hidden achievement: ${achievementId}`);
                    return;
                }

                const achievementElement = createAchievementElement(achievementId, achievement, isUnlocked);
                achievementsGrid.appendChild(achievementElement);
                visibleAchievements++;
            });

            console.log(`‚úÖ Displayed ${visibleAchievements} achievements`);

            if (visibleAchievements === 0) {
                achievementsGrid.innerHTML = '<div class="no-achievements">V t√©to kategorii zat√≠m nem√°te ≈æ√°dn√© trofeje.</div>';
            }

            updateDebugInfo();
        }

        function createAchievementElement(achievementId, achievement, isUnlocked) {
            const achievementDiv = document.createElement('div');
            achievementDiv.className = `achievement-item ${isUnlocked ? 'unlocked' : 'locked'}`;
            achievementDiv.dataset.achievementId = achievementId;
            achievementDiv.dataset.rarity = achievement.rarity;

            const rarityConfig = RARITY_CONFIG[achievement.rarity] || RARITY_CONFIG.common;
            
            if (isUnlocked && rarityConfig.glow !== 'none') {
                achievementDiv.style.boxShadow = rarityConfig.glow;
            }

            const categoryName = ACHIEVEMENT_CATEGORIES[achievement.category]?.name || achievement.category;

            achievementDiv.innerHTML = `
                <div class="achievement-icon" style="color: ${rarityConfig.color}">
                    ${isUnlocked ? achievement.icon : 'üîí'}
                </div>
                <div class="achievement-info">
                    <h3 class="achievement-name">${isUnlocked ? achievement.name : '???'}</h3>
                    <p class="achievement-description">${isUnlocked ? achievement.description : 'Skryt√Ω √∫spƒõch'}</p>
                    <div class="achievement-meta">
                        <span class="achievement-rarity" style="color: ${rarityConfig.color}">
                            ${rarityConfig.name}
                        </span>
                        <span class="achievement-category">
                            ${categoryName}
                        </span>
                    </div>
                </div>
            `;

            if (isUnlocked) {
                achievementDiv.addEventListener('click', () => showAchievementDetail(achievementId));
            }

            return achievementDiv;
        }

        function updateProgressStats() {
            if (!ACHIEVEMENTS_CONFIG || typeof getUnlockedAchievements !== 'function') {
                return;
            }

            // Poƒç√≠tej pouze non-hidden achievementy pro total
            const visibleAchievements = Object.keys(ACHIEVEMENTS_CONFIG).filter(id => {
                const achievement = ACHIEVEMENTS_CONFIG[id];
                const isUnlocked = isAchievementUnlocked(id);
                return !achievement.hidden || isUnlocked;
            });

            const totalAchievements = visibleAchievements.length;
            const unlockedAchievements = getUnlockedAchievements();
            const completionPercentage = totalAchievements > 0 ? Math.round((unlockedAchievements.length / totalAchievements) * 100) : 0;

            document.getElementById('total-achievements').textContent = totalAchievements;
            document.getElementById('unlocked-achievements').textContent = unlockedAchievements.length;
            document.getElementById('completion-percentage').textContent = `${completionPercentage}%`;
        }

        function setupFilterButtons() {
            const filterContainer = document.getElementById('categoryFilter');
            
            filterContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    // Remove active class from all buttons
                    filterContainer.querySelectorAll('.filter-btn').forEach(btn => 
                        btn.classList.remove('active')
                    );
                    
                    // Add active class to clicked button
                    e.target.classList.add('active');
                    
                    // Filter achievements
                    currentFilter = e.target.dataset.category;
                    loadAchievements(currentFilter);
                }
            });
        }

        function setupModal() {
            const modal = document.getElementById('achievementModal');
            const closeBtn = document.getElementById('achievementModalCloseBtn');

            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modal.classList.contains('visible')) {
                    closeModal();
                }
            });
        }

        function showAchievementDetail(achievementId) {
            const achievement = ACHIEVEMENTS_CONFIG[achievementId];
            const achievementData = getAchievementData();
            const unlockData = achievementData[achievementId];

            if (!achievement || !unlockData) return;

            const modal = document.getElementById('achievementModal');
            const rarityConfig = RARITY_CONFIG[achievement.rarity] || RARITY_CONFIG.common;

            document.getElementById('modalAchievementIcon').textContent = achievement.icon;
            document.getElementById('modalAchievementIcon').style.color = rarityConfig.color;
            document.getElementById('modalAchievementName').textContent = achievement.name;
            document.getElementById('modalAchievementDescription').textContent = achievement.description;
            document.getElementById('modalAchievementRarity').textContent = rarityConfig.name;
            document.getElementById('modalAchievementRarity').style.color = rarityConfig.color;
            document.getElementById('modalAchievementCategory').textContent = 
                ACHIEVEMENT_CATEGORIES[achievement.category]?.name || achievement.category;

            if (unlockData.unlockedAt) {
                const unlockDate = new Date(unlockData.unlockedAt);
                document.getElementById('modalUnlockDateText').textContent = 
                    unlockDate.toLocaleDateString('cs-CZ') + ' ' + unlockDate.toLocaleTimeString('cs-CZ');
                document.getElementById('modalUnlockDate').style.display = 'block';
            } else {
                document.getElementById('modalUnlockDate').style.display = 'none';
            }

            modal.classList.add('visible');
        }

        function closeModal() {
            const modal = document.getElementById('achievementModal');
            modal.classList.remove('visible');
        }

        // Hlavn√≠ inicializaƒçn√≠ sekvence
        document.addEventListener('DOMContentLoaded', () => {
            console.log("üìÑ Inventory page loaded");
            
            // Poƒçk√°me na naƒçten√≠ v≈°ech skript≈Ø
            setTimeout(() => {
                console.log("üöÄ Starting gamification initialization...");
                
                const initSuccess = initializeGamificationSystem();
                
                if (initSuccess) {
                    // Poƒçk√°me je≈°tƒõ chvilku a pak inicializujeme invent√°≈ô
                    setTimeout(() => {
                        initializeInventory();
                        setupFilterButtons();
                        setupModal();
                    }, 200);
                } else {
                    console.error("‚ùå Gamification initialization failed, retrying...");
                    
                    // Pokus o opakov√°n√≠ za 1 sekundu
                    setTimeout(() => {
                        console.log("üîÑ Retrying gamification initialization...");
                        const retrySuccess = initializeGamificationSystem();
                        
                        if (retrySuccess) {
                            setTimeout(() => {
                                initializeInventory();
                                setupFilterButtons();
                                setupModal();
                            }, 200);
                        } else {
                            console.error("‚ùå Gamification initialization failed completely");
                            const grid = document.getElementById('achievements-grid');
                            grid.innerHTML = '<div class="no-achievements">‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ syst√©mu achievement≈Ø. Zkuste obnovit str√°nku.</div>';
                        }
                    }, 1000);
                }
                
                updateDebugInfo();
            }, 500);
        });

        // Listen for achievement unlocks (if user is on this page when achievement is unlocked)
        window.addEventListener('storage', (event) => {
            if (event.key === 'arAchievements') {
                updateProgressStats();
                // Reload current filter
                loadAchievements(currentFilter);
            }
        });
    </script>

</body>
</html>
