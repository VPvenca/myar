<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    <!-- A-Frame a AR.js - funkční verze -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <link rel="stylesheet" href="/assets/stezka_vino/css/stezka.css">

     <!-- Gamifikační skripty - OPRAVENÉ POŘADÍ -->
    <script src="/gamification-config.js"></script>
    <script src="/gamification.js"></script>
    <script src="/game/vino_stezka_config.js"></script>
    <link rel="stylesheet" href="/css/tutorial.css">
    <script src="/tutorial.js"></script>
    
    <!-- MODULARIZOVANÉ SKRIPTY -->
    <script src="/assets/shared/js/core_utils.js"></script>
    <script src="/assets/shared/js/ar_manager.js"></script>
    <script src="/assets/shared/js/audio_ui.js"></script>
    <script src="/assets/stezka_vino/js/wine_app.js"></script>
    
</head>
<body>
    <!-- UI Elementy -->
    <a href="/assets/stezka_vino/vinarska_stezka.html" class="back-button ui-element">
        🍇 Zpět do Menu
    </a>
    
    <div class="distance-info ui-element" id="distanceInfo">
        🍷 Hledám nejbližší zajímavost...
    </div>
    
    <div class="navigation ui-element">
        <div class="nav-toggle" id="navToggle">🍷 Vinná Navigace</div>
        <div class="nav-content" id="navContent">
            <div id="targetsList"></div>
            <div id="clearSelection" style="display: none; background: tomato; color: white; padding: 5px; text-align: center; margin-top: 10px; border-radius: 5px; cursor: pointer;">
                ✕ Zrušit výběr
            </div>
        </div>
    </div>
    
    <!-- UPRAVENÉ AUDIO TLAČÍTKO - POUZE IKONA -->
    <div class="audio-info ui-element" id="audioInfo">🔊</div>
    <div class="rotation-hint" id="rotationHint">🔄 Tažením otočíte objekt</div>
    
    <!--  Vinný kvíz -->
    <div class="wine-quiz ui-element" id="wineQuiz">
        <div class="quiz-question" id="quizQuestion"></div>
        <div class="quiz-answers" id="quizAnswers"></div>
        <div class="quiz-explanation" id="quizExplanation"></div>
        <button class="quiz-close" id="quizClose">Pokračovat v cestě 👣</button>
        <div class="quiz-progress" id="quizProgress"></div>
    </div>
    
    <!-- Gamifikační status - SKRYTO -->
    <div class="gamification-status ui-element" id="gamificationStatus" style="display: none !important;">🎮 Gamifikace načítá...</div>
    
    <!-- Debug tlačítko - SKRYTO -->
    <button class="debug-button ui-element" id="debugButton" style="display: none !important;">🔧 Debug</button>

    <!-- A-Frame AR scéna s GPS pozicováním - PRÁZDNÁ SCÉNA -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        device-orientation-permission-ui="enabled: false"
        id="arScene">

        <a-assets>
            <!-- GLB modely vína -->
            <a-asset-item id="wine-model-1" src="/assets/stezka_vino/3d/sud.glb"></a-asset-item>
            <a-asset-item id="wine-model-2" src="/assets/stezka_vino/3d/lis.glb"></a-asset-item>
            <a-asset-item id="wine-model-3" src="/assets/stezka_vino/3d/urban.glb"></a-asset-item>
            <a-asset-item id="wine-model-4" src="/assets/stezka_vino/3d/vinar.glb"></a-asset-item>
            
            <!-- Audio soubory -->
            <audio id="audio1" src="/assets/stezka_vino/mp3/sud.mp3" preload="auto"></audio>
            <audio id="audio2" src="/assets/stezka_vino/mp3/lis.mp3" preload="auto"></audio>
            <audio id="audio3" src="/assets/stezka_vino/mp3/urban.mp3" preload="auto"></audio>
            <audio id="audio4" src="/assets/stezka_vino/mp3/vinar.mp3" preload="auto"></audio>
        </a-assets>

        <!-- Kamera s geolokací -->
        <a-camera 
            gps-camera
            rotation-reader>
        </a-camera>

        <!-- ŽÁDNÉ AR OBJEKTY - BUDOU PŘIDÁNY DYNAMICKY -->

        <!-- Základní osvětlení -->
        <a-light type="ambient" color="#ffffff" intensity="1.0" id="ambientLight"></a-light>
        <a-light 
            type="directional" 
            color="#ffffff" 
            intensity="1.0" 
            position="2 8 3"
            id="sunLight">
        </a-light>
        <a-light 
            type="point" 
            color="#ffffff" 
            intensity="1.0" 
            position="-2 4 2"
            distance="20"
            id="fillLight">
        </a-light>
    </a-scene>

    <script>
        // === APLIKAČNÍ KONSTRANTY ===
        const PROXIMITY_THRESHOLD = 15;
        const AR_VISIBILITY_THRESHOLD = 30;
        const AUDIO_THRESHOLD = 15;
        
        // Definice vinných markerů
        const markers = [
            { 
                id: "sud", 
                lat: 49.088936, 
                lng: 17.134380, 
                name: "🏺 Sud",
                description: "Dřevěný sud na víno",
                audioId: "audio1"
            },
            { 
                id: "lis", 
                lat: 49.086313, 
                lng: 17.133470,
                name: "⚙️ Lis", 
                description: "Ruční lis na révu",
                audioId: "audio2"
            },
            { 
                id: "urban", 
                lat: 49.081795, 
                lng: 17.130387,
                name: "✝️ Urban",
                description: "Svatý Urban patron vinařů",
                audioId: "audio3"
            },
            { 
                id: "vinar", 
                lat: 49.083583, 
                lng: 17.132751,
                name: "🧔 Vinař",
                description: "Vinař",
                audioId: "audio4"
            }
        ];

        // === HELPER FUNKCE PRO AR-MANAGER ===
        function getGLBModelForMarker(markerId) {
            switch(markerId) {
                case 'sud': return '#wine-model-1';
                case 'lis': return '#wine-model-2';
                case 'urban': return '#wine-model-3';
                case 'vinar': return '#wine-model-4';
                default: return '#wine-model-1';
            }
        }

        function getScaleForMarker(markerId) {
            switch(markerId) {
                case 'sud': 
                case 'lis': 
                    return "7 7 7";
                case 'urban':
                case 'vinar':
                    return "8 8 8";
                default: 
                    return "7 7 7";
            }
        }

        // === HLAVNÍ FUNKCE APLIKACE ===
        function checkProximityToMarkers() {
            const userPos = CoreUtils.getUserPosition();
            if (!userPos) return;
            
            console.log("Checking proximity with full modular system...");
            let shouldStopAudio = true;
            let markersActivatedThisCheck = [];
            
            markers.forEach(marker => {
                const distance = CoreUtils.calculateDistance(
                    userPos.lat, userPos.lng,
                    marker.lat, marker.lng
                );
                
                const isCurrentlyInScene = ARManager.isARObjectInScene(marker.id);
                const shouldBeInScene = distance <= AR_VISIBILITY_THRESHOLD;
                
                console.log(`${marker.id}: distance=${distance.toFixed(1)}m, inScene=${isCurrentlyInScene}, shouldBe=${shouldBeInScene}`);
                
                // AR objekty management
                if (shouldBeInScene && !isCurrentlyInScene) {
                    ARManager.addARObjectToScene(marker.id);
                } else if (!shouldBeInScene && isCurrentlyInScene) {
                    ARManager.removeARObjectFromScene(marker.id);
                }
                
                // Audio logika
                if (distance <= AUDIO_THRESHOLD && isCurrentlyInScene) {
                    AudioUI.playAudio(marker.id, markers);
                    shouldStopAudio = false;
                    console.log(`🎵 Audio playing for ${marker.id}`);
                }
                
                // Gamifikace
                if (distance <= PROXIMITY_THRESHOLD && isCurrentlyInScene) {
                    console.log(`🎯 Wine marker activated: ${marker.id}`);
                    markersActivatedThisCheck.push(marker.id);
                    WineApp.recordWineMarkerActivation(marker.id);
                }
            });
            
            if (shouldStopAudio) {
                AudioUI.stopCurrentAudio();
            }
            
            const activeCount = ARManager.getActiveARObjectsCount();
            console.log(`📊 Wine AR Status: ${activeCount} objects in scene`);
        }

        // === UI FUNKCIONALITA (DELEGOVÁNO NA MODULY) ===
        function updateNavigation() {
            AudioUI.updateNavigation(markers, CoreUtils.formatDistance, CoreUtils.calculateDistance);
            updateDistanceDisplay();
        }

        function updateDistanceDisplay() {
            const thresholds = {
                AUDIO_THRESHOLD,
                AR_VISIBILITY_THRESHOLD
            };
            
            AudioUI.updateDistanceDisplay(markers, CoreUtils.formatDistance, CoreUtils.calculateDistance, thresholds, WineApp.getQuizProgress);
        }

        function selectTarget(targetId) {
            AudioUI.selectTarget(targetId);
            updateNavigation();
        }

        function clearSelection() {
            AudioUI.clearSelection();
            updateNavigation();
        }

        // === DEBUG FUNKCE ===
        function getWineARSceneStatus() {
            return ARManager.debugARSceneStatus();
        }

        function forceCleanWineARScene() {
            ARManager.forceCleanARScene();
        }

        function debugWineApp() {
            return WineApp.debugWineAppStatus();
        }

        // === HLAVNÍ INICIALIZACE ===
        window.addEventListener('load', () => {
            console.log("🚀 Starting modular wine AR application...");
            console.log("📦 Modules loaded: CoreUtils, ARManager, AudioUI, WineApp");
            
            // Inicializace gamifikace
            setTimeout(() => {
                WineApp.initializeGameification();
            }, 2000);
            
            // Počkáme na A-Frame
            document.querySelector('a-scene').addEventListener('loaded', () => {
                console.log("A-Frame scene loaded");
                
                // Inicializace AR scény
                setTimeout(() => {
                    ARManager.initializeARScene(markers, getGLBModelForMarker, getScaleForMarker);
                    console.log("🍷 Wine AR scene initialized");
                }, 1000);
                
                // Nastavení event listenerů
                AudioUI.setupUIEventListeners();
                WineApp.setupWineAppEventListeners();
                
                // Nastavení rotace modelů
                ARManager.setupModelRotation();
                
                // GPS inicializace
                CoreUtils.getCurrentPosition(
                    (position) => {
                        console.log("✅ GPS pozice získána:", position);
                        document.getElementById('distanceInfo').innerHTML = '🍇 GPS aktivní';
                        checkProximityToMarkers();
                        updateNavigation();
                    },
                    (error) => {
                        console.warn("⚠️ GPS chyba:", error);
                        document.getElementById('distanceInfo').innerHTML = '🔄 Používám testovací pozici';
                        checkProximityToMarkers();
                        updateNavigation();
                    }
                );
                
                // Sledování GPS pozice
                CoreUtils.watchPosition((position) => {
                    checkProximityToMarkers();
                    updateNavigation();
                    WineApp.checkDistanceForQuiz();
                });
                
                // Spuštění tutorialu
                WineApp.startTutorialWhenReady();
                
                // Pravidelná kontrola kvízů
                setInterval(() => {
                    WineApp.checkDistanceForQuiz();
                }, 3000);
            });
            
            // Debug funkce do globálního scope
            window.getWineARStatus = getWineARSceneStatus;
            window.forceCleanWineARScene = forceCleanWineARScene;
            window.debugWineApp = debugWineApp;
            window.debugQuizzes = WineApp.debugQuizSystem;
            window.resetQuizzes = WineApp.resetAllQuizzes;
            window.activateQuizAchievement = WineApp.directActivateWineQuizAchievement;
            
            console.log("💡 Debug commands available:");
            console.log("   • getWineARStatus() - AR objekty status");
            console.log("   • debugWineApp() - kompletní wine app status");
            console.log("   • debugQuizzes() - kvízový systém debug");
            console.log("   • resetQuizzes() - reset všech kvízů");
            console.log("   • CoreUtils.debugGPSStatus() - GPS debug");
            console.log("   • ARManager.testARObjectToggle('sud') - test AR objektů");
            console.log("   • AudioUI.testAudioPlayback('sud', markers) - test audia");
        });

        console.log("🍇 Modular Wine AR application loaded successfully!");
        console.log("📦 Active modules: CoreUtils, ARManager, AudioUI, WineApp");
    </script>
</body>
</html>
