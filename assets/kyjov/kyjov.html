<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/img/favicon.png" />
    <title>AR Aplikace</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/buttons.css">
    <link rel="stylesheet" href="/css/modal.css">
    <link rel="stylesheet" href="/css/text-block.css">
    <link rel="stylesheet" href="/css/links.css">
    <link rel="stylesheet" href="/css/pages.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/img/apple_touch_icon_192x192.png">
    
    <!-- CRITICAL: Styly pro hvƒõzdy MUS√ç b√Ωt v <head> pro zamezen√≠ FOUC -->
    <style>
        /* Skryjeme loading indik√°tor ve v√Ωchoz√≠m stavu */
        .star-loading {
            display: none;
            color: #999;
            font-size: 0.8em;
            opacity: 0.6;
            animation: pulse 1.5s infinite;
        }
        
        /* Zobraz√≠me loading indik√°tor pouze kdy≈æ je explicitnƒõ pot≈ôeba */
        .star-display.loading .star-loading {
            display: inline;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Smooth transition kdy≈æ se hvƒõzdy naƒçtou */
        .star-display {
            transition: all 0.3s ease;
            min-height: 20px; /* Rezervujeme m√≠sto pro hvƒõzdy */
            display: inline-flex;
            align-items: center;
        }
        
        /* Styling pro hvƒõzdy */
        .star-display img {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Zajist√≠me, ≈æe se hvƒõzdy nikdy nep≈ôekr√Ωvaj√≠ s loading indik√°torem */
        .star-display:not(.loading) .star-loading {
            display: none !important;
        }
    </style>
</head>
<body class="home-page">

    <div class="page-wrapper">

        <header class="app-header">
            <img src="/img/augview.png" alt="Logo AR Aplikace" id="app-logo">
            <h1>Vyberte AR Sc√©nu</h1>
        </header>

        <main>
            <div class="menu-content">
                <a href="/assets/kyjov/terce.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/terce_thumb.png" alt="" class="button-icon">
                    <span class="button-text">st≈ôeleck√© terƒçe</span>
                    <span class="star-display" data-scene-id="/assets/kyjov/terce.html">
                        <!-- Loading indik√°tor je skryt√Ω ve v√Ωchoz√≠m stavu -->
                        <div class="star-loading">‚è≥</div>
                    </span>
                </a>
                <a href="/assets/kyjov/florian.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/florian_thumb.png" alt="" class="button-icon">
                    <span class="button-text">obraz sv.Flori√°na</span>
                    <span class="star-display" data-scene-id="/assets/kyjov/florian.html">
                        <div class="star-loading">‚è≥</div>
                    </span>
                </a>
                <a href="/assets/kyjov/scena_1.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/obrazy_thumb.png" alt="" class="button-icon">
                    <span class="button-text">obrazy v mezipat≈ôe</span>
                    <span class="star-display" data-scene-id="/assets/kyjov/scena_1.html">
                        <div class="star-loading">‚è≥</div>
                    </span>
                </a>
                <a href="/assets/kyjov/scena_3.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/vedro_thumb.png" alt="" class="button-icon">
                    <span class="button-text">3D vƒõdro</span>
                    <span class="star-display" data-scene-id="/assets/kyjov/scena_3.html">
                        <div class="star-loading">‚è≥</div>
                    </span>
                </a>
                <a href="/assets/kyjov/scena_2.html" class="menu-button icon-button">
                    <img src="/assets/kyjov/thumb/hadanky_thumb.png" alt="" class="button-icon">
                    <span class="button-text">H√°danky</span>
                    <span class="star-display" data-scene-id="/assets/kyjov/scena_2.html">
                        <div class="star-loading">‚è≥</div>
                    </span>
                </a>
            </div>

            <div class="centered-controls">
                <div class="back-button-container">
                    <a href="/muzea_galerie.html" class="menu-button back-button">
                        Zpƒõt
                    </a>
                </div>
            </div>

        </main>

        <!-- PLOVOUC√ç TLAƒå√çTKA v prav√©m doln√≠m rohu -->
        <div class="floating-buttons">
            <!-- Tlaƒç√≠tko mapy -->
            <a href="https://www.google.com/maps/search/?api=1&query=t%C5%99.+Palack%C3%A9ho+1373%2F13a%2C+697+01+Kyjov+1" 
               target="_blank" 
               rel="noopener noreferrer" 
               class="floating-button map-floating-button"
               title="Zobrazit na mapƒõ">
                <svg class="map-icon" viewBox="0 0 24 24">
                    <path d="M20.5,3L20.34,3.03L15,5.1L9,3L3.36,4.9C3.15,4.97 3,5.15 3,5.38V20.5A0.5,0.5 0 0,0 3.5,21L3.66,20.97L9,18.9L15,21L20.64,19.1C20.85,19.03 21,18.85 21,18.62V3.5A0.5,0.5 0 0,0 20.5,3M10,5.47L14,6.87V18.53L10,17.13V5.47M5,6.46L8,5.45V17.15L5,18.31V6.46M16,18.55L19,17.54V5.84L16,6.9V18.55Z"/>
                </svg>
            </a>
            
            <!-- Tlaƒç√≠tko n√°povƒõdy -->
            <button id="help-button" class="floating-button help-icon-button" title="N√°povƒõda">?</button>
        </div>

        <footer class="app-footer">
            <p>¬© 2025 Vytvo≈ôil V√°clav Pƒõnƒç√≠k</p>
        </footer>

    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>N√°povƒõda</h2>
            <p>
                Vyberte si jednu z dostupn√Ωch sc√©n pomoc√≠ tlaƒç√≠tek v hlavn√≠ nab√≠dce.
                Po spu≈°tƒõn√≠ sc√©ny postupujte podle instrukc√≠ na obrazovce pro zobrazen√≠
                roz≈°√≠≈ôen√© reality.
            </p>
            <p>POZOR! Je nutn√© povolit p≈ô√≠stup ke kame≈ôe za≈ô√≠zen√≠!</p>
            
            <h2>Menu Panel</h2>
            <div class="help-items-container">
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/terce_thumb.png" alt="terce" class="inline-icon">
                    <p>St≈ôeleck√© terƒçe se nach√°zej√≠ v p≈ô√≠zem√≠ (expozice Historie).</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/florian_thumb.png" alt="florian" class="inline-icon">
                    <p>Obraz sv.Flori√°na se nach√°zej√≠ v p≈ô√≠zem√≠ (expozice Historie / Hasiƒçi).</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/obrazy_thumb.png" alt="obrazy" class="inline-icon">
                    <p>Portr√©t MUDr.Jokl√≠ka a obraz t≈ôetihor se nach√°z√≠ na schodi≈°ti v mezipat≈ôe.</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/vedro_thumb.png" alt="vedro" class="inline-icon">
                    <p>3D vizualizace vƒõdra. Polo≈æte na st≈Øl pohlednici a zami≈ôte na ni. Objev√≠ se 3d objekt, kter√Ω si m≈Ø≈æete prohl√©dnout ze v≈°ech stran.</p>
                </div>
                <hr>
                <div class="help-item">
                    <img src="/assets/kyjov/thumb/hadanky_thumb.png" alt="hadanky" class="inline-icon">
                    <p>Jedn√° se o demoverzi h√°danek k p≈ôedstaven√≠ projektu AugView.</p>
                </div>
                <hr>
            </div>
            
            <h2>Sb√≠rejte hvƒõzdy!</h2>
            <div class="help-items-container">
                <div class="help-item"> 
                    <img src="/img/stars.png" alt="stars" class="inline-icon">
                    <p>Hvƒõzdy ukazuj√≠, jak moc jste zv√≠dav√≠. Objevuj√≠ se u tlaƒç√≠tek se sc√©nami.
                       Za zhl√©dnut√≠ v≈°ech sc√©n v jedn√© kategorii z√≠sk√°te zlatou hvƒõzdu.
                       Pokud si p≈ôehrajete alespo≈à polovinu, dostanete st≈ô√≠brnou hvƒõzdu.
                       A bronzovou z√≠sk√°te u≈æ jen za kr√°tk√© nahl√©dnut√≠.</p>
                    <p>
                      C√≠lem je nasb√≠rat v≈°echny zlat√© hvƒõzdy ‚Äì to je ta prav√° v√Ωzva!
                      A kdy≈æ se v√°m to poda≈ô√≠, ƒçek√° v√°s odmƒõna na recepci.</p>
                </div>  
            </div>
                     
            <p>Ujistƒõte se, ≈æe m√°te dostatek svƒõtla a sledujte okol√≠.</p>
            <p>Aplikace vyu≈æ√≠v√° Mind AR / A frame.</p>

            <button id="close-help-button" class="menu-button modal-close-button">Zpƒõt do menu</button>
        </div>
    </div>

    <!-- GAMIFIKAƒåN√ç SKRIPTY - v spr√°vn√©m po≈ôad√≠ -->
    <script src="/gamification-config.js"></script>
    <script src="/game/kyjov-config.js"></script>
    <script src="/gamification.js"></script>
    
    <!-- Z√ÅKLADN√ç LOGIKA STR√ÅNKY -->
    <script src="/script.js"></script>

    <script>
        // === OPTIMALIZOVAN√Å INICIALIZACE BEZ BLIK√ÅN√ç ===
        
        let gamificationReady = false;
        let starsDisplayed = false;
        
        // Funkce pro kontrolu dostupnosti gamifikace
        function checkGamificationReady() {
            return (
                typeof initializeExpositions === 'function' &&
                typeof SCENE_CONFIG !== 'undefined' &&
                typeof ACHIEVEMENTS_CONFIG !== 'undefined' &&
                typeof ACHIEVEMENT_CATEGORIES !== 'undefined' &&
                typeof getCurrentExpositionId === 'function' &&
                typeof getSceneStarLevel === 'function' &&
                typeof displayStars === 'function'
            );
        }
        
        // Promise-based ƒçek√°n√≠ na gamifikaci s optimalizovan√Ωm timingem
        function waitForGamification() {
            return new Promise((resolve) => {
                // Pokud je u≈æ ready, vra≈• okam≈æitƒõ
                if (checkGamificationReady()) {
                    resolve(true);
                    return;
                }
                
                let attempts = 0;
                const maxAttempts = 100; // 10 sekund maximum
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (checkGamificationReady()) {
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }
        
        // Optimalizovan√° inicializace
        async function initializeGamificationSystem() {
            const isReady = await waitForGamification();
            
            if (!isReady) {
                console.error("‚ùå Gamification system failed to load");
                return false;
            }
            
            try {
                initializeExpositions();
                console.log("‚úÖ Exposition system initialized");
            } catch (error) {
                console.error("‚ùå Failed to initialize expositions:", error);
                return false;
            }

            // Fin√°ln√≠ validace
            if (!SCENE_CONFIG || Object.keys(SCENE_CONFIG).length === 0) {
                console.error("‚ùå SCENE_CONFIG is empty");
                return false;
            }

            gamificationReady = true;
            return true;
        }

        // Optimalizovan√© zobrazen√≠ hvƒõzd BEZ blik√°n√≠
        function displayStarsOptimized() {
            if (starsDisplayed || !gamificationReady) {
                return;
            }
            
            const starDisplayElements = document.querySelectorAll('.star-display[data-scene-id]');
            const currentExpositionId = getCurrentExpositionId();
            
            if (!currentExpositionId || currentExpositionId === 'unknown') {
                console.error("‚ùå Cannot determine exposition ID");
                return;
            }

            // Batch processing pro lep≈°√≠ performance
            const updates = [];
            
            starDisplayElements.forEach((starElement) => {
                const sceneId = starElement.dataset.sceneId;

                if (SCENE_CONFIG && SCENE_CONFIG[sceneId]) {
                    try {
                        const level = getSceneStarLevel(currentExpositionId, sceneId);
                        updates.push({ element: starElement, level, sceneId });
                    } catch (error) {
                        console.error(`‚ùå Error processing ${sceneId}:`, error);
                    }
                }
            });
            
            // Aplikuj v≈°echny zmƒõny najednou (batch DOM updates)
            updates.forEach(({ element, level, sceneId }) => {
                // Odstra≈à loading t≈ô√≠du (t√≠m se skryje loading indik√°tor)
                element.classList.remove('loading');
                
                // Vyƒçisti obsah
                element.innerHTML = '';
                
                // Zobraz hvƒõzdy
                displayStars(element, level);
                
                console.log(`‚≠ê Star displayed: ${sceneId} = ${level}`);
            });
            
            starsDisplayed = true;
            console.log(`‚úÖ ${updates.length} stars displayed without flashing`);
        }

        // Hlavn√≠ inicializaƒçn√≠ sekvence
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("üìÑ DOM loaded - initializing optimized gamification...");
            
            // NEBUDEME zobrazovat loading indik√°tory dokud nen√≠ nutn√©
            // (jsou skryt√© pomoc√≠ CSS)
            
            const initSuccess = await initializeGamificationSystem();
            
            if (initSuccess) {
                // Okam≈æit√© zobrazen√≠ hvƒõzd
                displayStarsOptimized();
            } else {
                console.error("‚ùå Gamification failed");
                
                // Pokud gamifikace sel≈æe, zobraz√≠me chybov√Ω stav
                document.querySelectorAll('.star-display').forEach(element => {
                    element.innerHTML = '<span style="color: #dc3545; font-size: 0.8em;">‚ùì</span>';
                    element.title = 'Chyba p≈ôi naƒç√≠t√°n√≠ gamifikace';
                });
            }
        });

        // Zabezpeƒçovac√≠ mechanismus
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!starsDisplayed && gamificationReady) {
                    console.log("üîÑ Backup: Attempting optimized star display...");
                    displayStarsOptimized();
                }
            }, 100);
        });

        // Debug funkce
        window.debugStars = function() {
            console.log("üêõ OPTIMIZED DEBUG:");
            console.log("- gamificationReady:", gamificationReady);
            console.log("- starsDisplayed:", starsDisplayed);
            console.log("- checkGamificationReady():", checkGamificationReady());
            
            // Force refresh
            starsDisplayed = false;
            displayStarsOptimized();
        };

    </script>

</body>
</html>
