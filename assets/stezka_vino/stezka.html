<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    <!-- A-Frame a AR.js - funkÄnÃ­ verze -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <link rel="stylesheet" href="/assets/stezka_vino/css/stezka.css">

     <!-- GamifikaÄnÃ­ skripty - OPRAVENÃ‰ POÅ˜ADÃ -->
    <script src="/gamification-config.js"></script>
    <script src="/gamification.js"></script>
    <script src="/game/vino_stezka_config.js"></script>
    <link rel="stylesheet" href="/css/tutorial.css">
    <script src="/tutorial.js"></script>
    
    <!-- MODULARIZOVANÃ‰ SKRIPTY -->
    <script src="/assets/shared/js/core_utils.js"></script>
    <script src="/assets/shared/js/ar_manager.js"></script>
    <script src="/assets/shared/js/audio_ui.js"></script>
    <script src="/assets/stezka_vino/js/wine_app.js"></script>
    
</head>
<body>
    <!-- UI Elementy -->
    <a href="/assets/stezka_vino/vinarska_stezka.html" class="back-button ui-element">
        ğŸ‡ ZpÄ›t do Menu
    </a>
    
    <div class="distance-info ui-element" id="distanceInfo">
        ğŸ· HledÃ¡m nejbliÅ¾Å¡Ã­ zajÃ­mavost...
    </div>
    
    <div class="navigation ui-element">
        <div class="nav-toggle" id="navToggle">ğŸ· VinnÃ¡ Navigace</div>
        <div class="nav-content" id="navContent">
            <div id="targetsList"></div>
            <div id="clearSelection" style="display: none; background: tomato; color: white; padding: 5px; text-align: center; margin-top: 10px; border-radius: 5px; cursor: pointer;">
                âœ• ZruÅ¡it vÃ½bÄ›r
            </div>
        </div>
    </div>
    
    <!-- UPRAVENÃ‰ AUDIO TLAÄŒÃTKO - POUZE IKONA -->
    <div class="audio-info ui-element" id="audioInfo">ğŸ”Š</div>
    <div class="rotation-hint" id="rotationHint">ğŸ”„ TaÅ¾enÃ­m otoÄÃ­te objekt</div>
    
    <!--  VinnÃ½ kvÃ­z -->
    <div class="wine-quiz ui-element" id="wineQuiz">
        <div class="quiz-question" id="quizQuestion"></div>
        <div class="quiz-answers" id="quizAnswers"></div>
        <div class="quiz-explanation" id="quizExplanation"></div>
        <button class="quiz-close" id="quizClose">PokraÄovat v cestÄ› ğŸ‘£</button>
        <div class="quiz-progress" id="quizProgress"></div>
    </div>
    
    <!-- GamifikaÄnÃ­ status - SKRYTO -->
    <div class="gamification-status ui-element" id="gamificationStatus" style="display: none !important;">ğŸ® Gamifikace naÄÃ­tÃ¡...</div>
    
    <!-- Debug tlaÄÃ­tko - SKRYTO -->
    <button class="debug-button ui-element" id="debugButton" style="display: none !important;">ğŸ”§ Debug</button>

    <!-- A-Frame AR scÃ©na s GPS pozicovÃ¡nÃ­m - PRÃZDNÃ SCÃ‰NA -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        device-orientation-permission-ui="enabled: false"
        id="arScene">

        <a-assets>
            <!-- GLB modely vÃ­na -->
            <a-asset-item id="wine-model-1" src="/assets/stezka_vino/3d/sud.glb"></a-asset-item>
            <a-asset-item id="wine-model-2" src="/assets/stezka_vino/3d/lis.glb"></a-asset-item>
            <a-asset-item id="wine-model-3" src="/assets/stezka_vino/3d/urban.glb"></a-asset-item>
            <a-asset-item id="wine-model-4" src="/assets/stezka_vino/3d/vinar.glb"></a-asset-item>
            
            <!-- Audio soubory -->
            <audio id="audio1" src="/assets/stezka_vino/mp3/sud.mp3" preload="auto"></audio>
            <audio id="audio2" src="/assets/stezka_vino/mp3/lis.mp3" preload="auto"></audio>
            <audio id="audio3" src="/assets/stezka_vino/mp3/urban.mp3" preload="auto"></audio>
            <audio id="audio4" src="/assets/stezka_vino/mp3/vinar.mp3" preload="auto"></audio>
        </a-assets>

        <!-- Kamera s geolokacÃ­ -->
        <a-camera 
            gps-camera
            rotation-reader>
        </a-camera>

        <!-- Å½ÃDNÃ‰ AR OBJEKTY - BUDOU PÅ˜IDÃNY DYNAMICKY -->

        <!-- ZÃ¡kladnÃ­ osvÄ›tlenÃ­ -->
        <a-light type="ambient" color="#ffffff" intensity="1.0" id="ambientLight"></a-light>
        <a-light 
            type="directional" 
            color="#ffffff" 
            intensity="1.0" 
            position="2 8 3"
            id="sunLight">
        </a-light>
        <a-light 
            type="point" 
            color="#ffffff" 
            intensity="1.0" 
            position="-2 4 2"
            distance="20"
            id="fillLight">
        </a-light>
    </a-scene>

    <script>
        // === APLIKAÄŒNÃ KONSTRANTY ===
        const PROXIMITY_THRESHOLD = 15;
        const AR_VISIBILITY_THRESHOLD = 30;
        const AUDIO_THRESHOLD = 15;
        
        // Definice vinnÃ½ch markerÅ¯
        const markers = [
            { 
                id: "sud", 
                lat: 49.088936, 
                lng: 17.134380, 
                name: "ğŸº Sud",
                description: "DÅ™evÄ›nÃ½ sud na vÃ­no",
                audioId: "audio1"
            },
            { 
                id: "lis", 
                lat: 49.086313, 
                lng: 17.133470,
                name: "âš™ï¸ Lis", 
                description: "RuÄnÃ­ lis na rÃ©vu",
                audioId: "audio2"
            },
            { 
                id: "urban", 
                lat: 49.081795, 
                lng: 17.130387,
                name: "âœï¸ Urban",
                description: "SvatÃ½ Urban patron vinaÅ™Å¯",
                audioId: "audio3"
            },
            { 
                id: "vinar", 
                lat: 49.083583, 
                lng: 17.132751,
                name: "ğŸ§” VinaÅ™",
                description: "VinaÅ™",
                audioId: "audio4"
            }
        ];

        // === HELPER FUNKCE PRO AR-MANAGER ===
        function getGLBModelForMarker(markerId) {
            switch(markerId) {
                case 'sud': return '#wine-model-1';
                case 'lis': return '#wine-model-2';
                case 'urban': return '#wine-model-3';
                case 'vinar': return '#wine-model-4';
                default: return '#wine-model-1';
            }
        }

        function getScaleForMarker(markerId) {
            switch(markerId) {
                case 'sud': 
                case 'lis': 
                    return "7 7 7";
                case 'urban':
                case 'vinar':
                    return "8 8 8";
                default: 
                    return "7 7 7";
            }
        }

        // === HLAVNÃ FUNKCE APLIKACE ===
        function checkProximityToMarkers() {
            const userPos = CoreUtils.getUserPosition();
            if (!userPos) return;
            
            console.log("Checking proximity with full modular system...");
            let shouldStopAudio = true;
            let markersActivatedThisCheck = [];
            
            markers.forEach(marker => {
                const distance = CoreUtils.calculateDistance(
                    userPos.lat, userPos.lng,
                    marker.lat, marker.lng
                );
                
                const isCurrentlyInScene = ARManager.isARObjectInScene(marker.id);
                const shouldBeInScene = distance <= AR_VISIBILITY_THRESHOLD;
                
                console.log(`${marker.id}: distance=${distance.toFixed(1)}m, inScene=${isCurrentlyInScene}, shouldBe=${shouldBeInScene}`);
                
                // AR objekty management
                if (shouldBeInScene && !isCurrentlyInScene) {
                    ARManager.addARObjectToScene(marker.id);
                } else if (!shouldBeInScene && isCurrentlyInScene) {
                    ARManager.removeARObjectFromScene(marker.id);
                }
                
                // Audio logika
                if (distance <= AUDIO_THRESHOLD && isCurrentlyInScene) {
                    AudioUI.playAudio(marker.id, markers);
                    shouldStopAudio = false;
                    console.log(`ğŸµ Audio playing for ${marker.id}`);
                }
                
                // Gamifikace
                if (distance <= PROXIMITY_THRESHOLD && isCurrentlyInScene) {
                    console.log(`ğŸ¯ Wine marker activated: ${marker.id}`);
                    markersActivatedThisCheck.push(marker.id);
                    WineApp.recordWineMarkerActivation(marker.id);
                }
            });
            
            if (shouldStopAudio) {
                AudioUI.stopCurrentAudio();
            }
            
            const activeCount = ARManager.getActiveARObjectsCount();
            console.log(`ğŸ“Š Wine AR Status: ${activeCount} objects in scene`);
        }

        // === UI FUNKCIONALITA (DELEGOVÃNO NA MODULY) ===
        function updateNavigation() {
            AudioUI.updateNavigation(markers, CoreUtils.formatDistance, CoreUtils.calculateDistance);
            updateDistanceDisplay();
        }

        function updateDistanceDisplay() {
            const thresholds = {
                AUDIO_THRESHOLD,
                AR_VISIBILITY_THRESHOLD
            };
            
            AudioUI.updateDistanceDisplay(markers, CoreUtils.formatDistance, CoreUtils.calculateDistance, thresholds, WineApp.getQuizProgress);
        }

        function selectTarget(targetId) {
            AudioUI.selectTarget(targetId);
            updateNavigation();
        }

        function clearSelection() {
            AudioUI.clearSelection();
            updateNavigation();
        }

        // === DEBUG FUNKCE ===
        function getWineARSceneStatus() {
            return ARManager.debugARSceneStatus();
        }

        function forceCleanWineARScene() {
            ARManager.forceCleanARScene();
        }

        function debugWineApp() {
            return WineApp.debugWineAppStatus();
        }

        // === HLAVNÃ INICIALIZACE ===
        window.addEventListener('load', () => {
            console.log("ğŸš€ Starting modular wine AR application...");
            console.log("ğŸ“¦ Modules loaded: CoreUtils, ARManager, AudioUI, WineApp");
            
            // Inicializace gamifikace
            setTimeout(() => {
                WineApp.initializeGameification();
            }, 2000);
            
            // PoÄkÃ¡me na A-Frame
            document.querySelector('a-scene').addEventListener('loaded', () => {
                console.log("A-Frame scene loaded");
                
                // Inicializace AR scÃ©ny
                setTimeout(() => {
                    ARManager.initializeARScene(markers, getGLBModelForMarker, getScaleForMarker);
                    console.log("ğŸ· Wine AR scene initialized");
                }, 1000);
                
                // NastavenÃ­ event listenerÅ¯
                AudioUI.setupUIEventListeners();
                WineApp.setupWineAppEventListeners();
                
                // NastavenÃ­ rotace modelÅ¯
                ARManager.setupModelRotation();
                
                // GPS inicializace
                CoreUtils.getCurrentPosition(
                    (position) => {
                        console.log("âœ… GPS pozice zÃ­skÃ¡na:", position);
                        document.getElementById('distanceInfo').innerHTML = 'ğŸ‡ GPS aktivnÃ­';
                        checkProximityToMarkers();
                        updateNavigation();
                    },
                    (error) => {
                        console.warn("âš ï¸ GPS chyba:", error);
                        document.getElementById('distanceInfo').innerHTML = 'ğŸ”„ PouÅ¾Ã­vÃ¡m testovacÃ­ pozici';
                        checkProximityToMarkers();
                        updateNavigation();
                    }
                );
                
                // SledovÃ¡nÃ­ GPS pozice
                CoreUtils.watchPosition((position) => {
                    checkProximityToMarkers();
                    updateNavigation();
                    WineApp.checkDistanceForQuiz();
                });
                
                // SpuÅ¡tÄ›nÃ­ tutorialu
                WineApp.startTutorialWhenReady();
                
                // PravidelnÃ¡ kontrola kvÃ­zÅ¯
                setInterval(() => {
                    WineApp.checkDistanceForQuiz();
                }, 3000);
            });
            
            // Debug funkce do globÃ¡lnÃ­ho scope
            window.getWineARStatus = getWineARSceneStatus;
            window.forceCleanWineARScene = forceCleanWineARScene;
            window.debugWineApp = debugWineApp;
            window.debugQuizzes = WineApp.debugQuizSystem;
            window.resetQuizzes = WineApp.resetAllQuizzes;
            window.activateQuizAchievement = WineApp.directActivateWineQuizAchievement;
            
            console.log("ğŸ’¡ Debug commands available:");
            console.log("   â€¢ getWineARStatus() - AR objekty status");
            console.log("   â€¢ debugWineApp() - kompletnÃ­ wine app status");
            console.log("   â€¢ debugQuizzes() - kvÃ­zovÃ½ systÃ©m debug");
            console.log("   â€¢ resetQuizzes() - reset vÅ¡ech kvÃ­zÅ¯");
            console.log("   â€¢ CoreUtils.debugGPSStatus() - GPS debug");
            console.log("   â€¢ ARManager.testARObjectToggle('sud') - test AR objektÅ¯");
            console.log("   â€¢ AudioUI.testAudioPlayback('sud', markers) - test audia");
        });

        console.log("ğŸ‡ Modular Wine AR application loaded successfully!");
        console.log("ğŸ“¦ Active modules: CoreUtils, ARManager, AudioUI, WineApp");
    </script>
</body>
</html>
