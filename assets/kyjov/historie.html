<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        /* Skrytí výchozího AR tlačítka MindAR */
        .mindar-ui-overlay .mindar-ui-scanning{
             display: none !important;
        }
    </style>
</head>
<body>
    <button id="startButton">Spustit AR</button>

    <a href="/assets/kyjov/kyjov.html" style="position: absolute; top: 10px; left: 10px; z-index: 1001; padding: 8px 15px; background-color: rgba(0,0,0,0.5); color: white; text-decoration: none; border-radius: 3px; font-size: 14px;">
        Zpět do Menu
    </a>

    <!-- Poznámka: Nastavil jsem uiLoading a uiError na 'no', aby se nekryly s vlastním tlačítkem -->
    <a-scene mindar-image="imageTargetSrc:/assets/kyjov/mind/historie.mind;
        maxTrack: 5; /* Zvyšte, pokud chcete sledovat více cílů současně */
        uiLoading: no; uiError: no;
        renderer: {colorManagement: true};
        physicallyCorrectLights: true;
        vr-mode-ui: {enabled: false};
        device-orientation-permission-ui: {enabled: false}">

        <a-assets>
            <!-- Videa -->
            <video id="video1" src="/assets/kyjov/mp4/selim.mp4" preload="auto" loop playsinline webkit-playsinline muted></video>
            <video id="video2" src="/assets/kyjov/mp4/terc_1.mp4" preload="auto" loop playsinline webkit-playsinline muted></video>
            <video id="video3" src="/assets/kyjov/mp4/terc_2.mp4" preload="auto" loop playsinline webkit-playsinline muted></video>
            <video id="video4" src="/assets/kyjov/mp4/terc_3.mp4" preload="auto" loop playsinline webkit-playsinline muted></video>
            <video id="video5" src="/assets/kyjov/mp4/florian.mp4" preload="auto" loop playsinline webkit-playsinline muted></video>

            <!-- Zvuky -->
            <audio id="audio1" src="/assets/kyjov/mp3/selim.mp3" preload="auto"></audio>
            <audio id="audio2" src="/assets/kyjov/mp3/terc_1.mp3" preload="auto"></audio>
            <audio id="audio3" src="/assets/kyjov/mp3/terc_2.mp3" preload="auto"></audio>
            <audio id="audio4" src="/assets/kyjov/mp3/terc_3.mp3" preload="auto"></audio>
            <audio id="audio5" src="/assets/kyjov/mp3/florian.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- Správně definované entity pro každý cíl -->
        <a-entity mindar-image-target="targetIndex: 0">
            <a-video id="videoEntity1" src="#video1" position="0 0 0" scale="1 1 1" width="1" height="1" autoplay="false"></a-video>
            <!-- Přizpůsobte width/height poměru stran vašeho videa -->
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1">
            <a-video id="videoEntity2" src="#video2" position="0 0 0" scale="1 1 1" width="1" height="1" autoplay="false"></a-video>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 2">
            <!-- Unikátní ID a správný src -->
            <a-video id="videoEntity3" src="#video3" position="0 0 0" scale="1 1 1" width="1" height="1" autoplay="false"></a-video>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 3">
            <!-- Unikátní ID a správný src -->
            <a-video id="videoEntity4" src="#video4" position="0 0 0" scale="1 1 1" width="1" height="1" autoplay="false"></a-video>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 4">
            <!-- Unikátní ID a správný src -->
            <a-video id="videoEntity5" src="#video5" position="0 0 0" scale="1 1 1" width="1" height="1" autoplay="false"></a-video>
        </a-entity>
    </a-scene>

    <script>
        const startButton = document.getElementById('startButton');
        const sceneEl = document.querySelector('a-scene');
        const numTargets = 5; // Počet vašich cílů/videí/zvuků

        let audioContext;
        const audioBuffers = []; // Pole pro uložení všech audio bufferů
        const audioSources = new Array(numTargets).fill(null); // Pole pro sledování aktivních zvuků

        // Funkce pro dekódování audio dat
        async function loadAudio(url) {
            if (!audioContext) return null; // Zajistíme, že AudioContext existuje
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                return await audioContext.decodeAudioData(arrayBuffer);
            } catch (error) {
                console.error(`Error loading audio ${url}:`, error);
                return null;
            }
        }

        // Funkce pro přehrání zvuku
        function playSound(buffer, index) {
            if (!buffer || !audioContext) return;
            // Zastavíme předchozí zvuk pro tento index, pokud hraje
            if (audioSources[index]) {
                try {
                    audioSources[index].stop();
                } catch (e) { /* Může selhat, pokud už bylo zastaveno */ }
            }
            // Vytvoříme a přehrajeme nový zdroj
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.onended = () => { // Resetujeme zdroj, když dohraje
                audioSources[index] = null;
            };
            source.start();
            audioSources[index] = source; // Uložíme referenci na aktivní zdroj
        }

        // Funkce pro zastavení zvuku
        function stopSound(index) {
             if (audioSources[index]) {
                try {
                    audioSources[index].stop();
                } catch (e) { /* Může selhat, pokud už bylo zastaveno */ }
                audioSources[index] = null;
            }
        }


        startButton.addEventListener('click', async () => {
            // Skryjeme tlačítko
            startButton.style.display = 'none';

            // Inicializace AudioContext po interakci uživatele
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                // Zkontrolujeme stav, zejména v Safari může vyžadovat "resume"
                 if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                 }
            }

             // Zobrazíme MindAR UI (pokud bylo skryto) a spustíme scénu
             // Pokud používáte vlastní tlačítko, toto nemusí být nutné
             // pokud MindAR startuje automaticky po načtení
             // sceneEl.emit('start-ar'); // Toto nemusí být správný způsob startu

             // --- Načtení všech zvuků ---
             console.log("Loading audio assets...");
             const loadPromises = [];
             for (let i = 1; i <= numTargets; i++) {
                const audioEl = document.getElementById(`audio${i}`);
                if (audioEl) {
                    loadPromises.push(loadAudio(audioEl.src));
                } else {
                    loadPromises.push(Promise.resolve(null)); // Přidáme null, pokud audio element neexistuje
                }
             }
             // Počkáme na načtení všech zvuků a uložíme buffery
             const loadedBuffers = await Promise.all(loadPromises);
             loadedBuffers.forEach((buffer, index) => {
                if (buffer) {
                    audioBuffers[index] = buffer;
                    console.log(`Audio ${index + 1} loaded.`);
                } else {
                     console.warn(`Audio ${index + 1} could not be loaded or element not found.`);
                }
             });
             console.log("Audio loading complete.");


             // --- Nastavení event listenerů pro všechny cíle ---
             for (let i = 0; i < numTargets; i++) {
                const targetEntity = document.querySelector(`[mindar-image-target="targetIndex: ${i}"]`);
                const videoEntity = document.getElementById(`videoEntity${i + 1}`); // ID jsou od 1

                if (targetEntity && videoEntity) {
                    const videoElement = videoEntity.components.material?.material?.map?.image; // Bezpečný přístup k video elementu

                    if (!videoElement) {
                        console.error(`Video element not found for videoEntity${i + 1}`);
                        continue; // Přeskočíme nastavení listenerů, pokud video není připraveno
                    }

                    // Zajistíme, že video je ztlumené na začátku (kvůli autoplay politikám)
                    videoElement.muted = true;

                    targetEntity.addEventListener('targetFound', () => {
                        console.log(`targetFound ${i} se spustil!`);
                        // Přehrání videa
                        videoElement.play().catch(e => console.error(`Video ${i+1} play failed:`, e));
                        // Přehrání zvuku (index je i)
                        if (audioBuffers[i]) {
                            playSound(audioBuffers[i], i);
                        } else {
                            console.log(`Audio buffer for target ${i} not ready.`);
                        }
                    });

                    targetEntity.addEventListener('targetLost', () => {
                        console.log(`targetLost ${i} se spustil!`);
                        // Pauznutí videa a reset času
                        videoElement.pause();
                        videoElement.currentTime = 0; // Volitelné: vrátí video na začátek
                        // Zastavení zvuku (index je i)
                        stopSound(i);
                    });

                } else {
                    console.warn(`Target entity or video entity not found for index ${i}`);
                }
             }

             console.log("Event listeners attached.");
        });

        // Tento kód zajišťuje, že scéna (a tedy MindAR) se začne vykreslovat
        // až po kliknutí na tlačítko, což může pomoci s interakcí.
        // Pokud máte problémy se startem, může být toto potřeba.
        // sceneEl.addEventListener('loaded', () => {
        //     // Scéna je načtená, ale ještě nespouštíme AR
        // });

    </script>
</body>
</html>
