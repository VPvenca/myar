<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- A-Frame a MindAR knihovny -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Gamifikační skripty - DŮLEŽITÉ POŘADÍ -->
    <script> const CURRENT_MUSEUM_ID = "muzeumKyjov"; </script>
    <script src="/gamification-config.js"></script>
    <script src="/gamification.js"></script> 
    <!-- Předpokládáme, že gamification.js obsahuje logy, které jsme přidali -->

    <style>
        /* Můžeš přidat CSS pro .main-scene-star-display, pokud ho chceš zobrazit */
        .main-scene-star-display {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background-color: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 3px;
        }
        .main-scene-star-display img {
            width: 24px; /* Nebo jiná velikost */
            height: 24px;
        }
    </style>
</head>
<body>
    <!-- Odkaz zpět a prvek pro zobrazení hvězdy aktuální scény -->
    <a href="/assets/kyjov/kyjov.html" style="position: absolute; top: 10px; left: 10px; z-index: 1001; padding: 8px 15px; background-color: rgba(0,0,0,0.5); color: white; text-decoration: none; border-radius: 3px; font-size: 14px;">
        Zpět do Menu Kyjov
    </a>
    <!-- Element pro zobrazení hvězdy této konkrétní AR scény -->
    <div class="main-scene-star-display">
        <!-- Hvězda bude vložena pomocí gamification.js -->
    </div>

    <a-scene
    mindar-image="imageTargetSrc: /assets/kyjov/mind/vedro.mind; uiLoading: yes; uiError: yes; autoStart: false;"
    renderer="colorManagement: true; physicallyCorrectLights: true;"
    vr-mode-ui="enabled: false;"
    device-orientation-permission-ui="enabled: false;"
    color-space="sRGB" <!-- Doporučeno pro colorManagement: true -->
    >
        <a-assets>
            <a-asset-item id="model1" src="/assets/kyjov/3d/vedro.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;"></a-camera>

        <!-- DŮLEŽITÉ: data-marker-id musí odpovídat ID v gamification-config.js -->
        <a-entity mindar-image-target="targetIndex: 0" data-marker-id="vedro_model_kyjov">
            <a-gltf-model 
                src="#model1" 
                position="0 0 0.1" 
                scale="1.5 1.5 1.5"  
                rotation="90 0 0"> 
            </a-gltf-model>
        </a-entity>
    </a-scene>

   <script>
function enableCamera() {
    // ... (tato funkce zůstává stejná) ...
     if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
         navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
             .then(function(stream) {
                 console.log("SCENA_3.HTML: ✅ Přístup k zadní kameře povolen!");
             })
             .catch(function(error) {
                 console.error("SCENA_3.HTML: ❌ Chyba přístupu k zadní kameře: ", error);
             });
     } else {
         console.error("SCENA_3.HTML: ❌ Tento prohlížeč nepodporuje přístup k médiím.");
     }
}

// Funkce pro inicializaci MindAR a gamifikace
function initializeArAndGamification() {
    console.log("SCENA_3.HTML: Spouštím initializeArAndGamification()");

    // Ověření gamifikačních skriptů
    if (typeof CURRENT_MUSEUM_ID === 'undefined' ||
        typeof MUSEUM_CONFIGS === 'undefined' ||
        typeof recordMarkerActivation !== 'function' ||
        typeof getCurrentScenePath !== 'function' ||
        typeof getCurrentSceneConfigForMuseum !== 'function') {
        console.error("SCENA_3.HTML - GAMIFIKACE CHYBA: Základní gamifikační proměnné nebo funkce nejsou dostupné.");
        return;
    }
    console.log("SCENA_3.HTML - Gamifikace: Všechny potřebné proměnné a funkce jsou dostupné.");

    const currentScenePath = getCurrentScenePath();
    const sceneConfig = getCurrentSceneConfigForMuseum();

    if (!sceneConfig) {
        console.warn(`SCENA_3.HTML - Gamifikace: Konfigurace pro scénu (${currentScenePath}) v muzeu "${CURRENT_MUSEUM_ID}" nenalezena.`);
    } else {
        console.log(`SCENA_3.HTML - Gamifikace: Konfigurace pro scénu "${sceneConfig.name}" načtena.`);
    }

    const sceneEl = document.querySelector('a-scene');
    if (!sceneEl) {
        console.error("SCENA_3.HTML: A-Frame scéna (<a-scene>) nenalezena.");
        return;
    }

    const mindARSystem = sceneEl.components['mindar-image-system'];
    if (mindARSystem) {
        console.log("SCENA_3.HTML: MindAR systém nalezen. Pokouším se spustit...");
        try {
            // Manuální start MindAR systému, pokud máš autoStart: false
            // Pokud je autoStart: true (výchozí), tento start není nutný, ale nevadí
            if (!mindARSystem.started) { // Kontrola, jestli už neběží
                mindARSystem.start();
            }
            console.log("SCENA_3.HTML: MindAR systém by měl být spuštěn.");

            // Nyní, když je MindAR systém potenciálně spuštěn, zkusíme najít target entitu
            // Ještě lepší je počkat na nějakou událost, že je MindAR opravdu připraven,
            // ale pro jednoduchost zkusíme krátké zpoždění nebo přímé hledání.
            // Můžeme použít observer, pokud by přímé hledání selhalo.

            // POZOR: 'mindar-image-target' je atribut komponenty, ale MindAR může přidávat i další signální atributy.
            // Zkusme obecnější selektor nejprve, pokud MindAR dynamicky mění atributy.
            // Selektor by měl být co nejpřesnější.
            const targetEntity = sceneEl.querySelector('a-entity[mindar-image-target]');
            // Pokud máš jen jeden target, můžeš použít i:
            // const targetEntity = document.querySelector('a-entity[data-marker-id="vedro_model_kyjov"]');
            // Nebo pokud vždy targetIndex=0:
            // const targetEntity = document.querySelector('a-entity[mindar-image-target][targetIndex="0"]');

            if (targetEntity) {
                console.log(`SCENA_3.HTML: Target entita NALEZENA:`, targetEntity);
                const markerIdFromHTML = targetEntity.getAttribute('data-marker-id');

                if (!markerIdFromHTML) {
                    console.warn("SCENA_3.HTML - Gamifikace: Nalezená target entita nemá atribut 'data-marker-id'.");
                } else {
                    console.log(`SCENA_3.HTML - Gamifikace: Marker ID z HTML: "${markerIdFromHTML}"`);
                    let isMarkerConfigured = false;
                    if (sceneConfig && sceneConfig.markers && sceneConfig.markers.includes(markerIdFromHTML)) {
                        isMarkerConfigured = true;
                        console.log(`SCENA_3.HTML - Gamifikace: Marker "${markerIdFromHTML}" je správně nakonfigurován.`);
                    } else {
                        console.warn(`SCENA_3.HTML - Gamifikace: Marker "${markerIdFromHTML}" NENÍ nakonfigurován pro tuto scénu.`);
                    }

                    if (isMarkerConfigured) {
                        targetEntity.addEventListener('targetFound', () => {
                            console.log(`SCENA_3.HTML - MindAR Event: Target "${markerIdFromHTML}" NALEZEN!`);
                            recordMarkerActivation(markerIdFromHTML);
                            console.log(`SCENA_3.HTML - Gamifikace: Zavoláno recordMarkerActivation("${markerIdFromHTML}").`);
                        });
                        targetEntity.addEventListener('targetLost', () => {
                            console.log(`SCENA_3.HTML - MindAR Event: Target "${markerIdFromHTML}" ZTRACEN!`);
                        });
                        console.log(`SCENA_3.HTML: Listenery 'targetFound' a 'targetLost' nastaveny pro "${markerIdFromHTML}".`);
                    }
                }
            } else {
                console.error("SCENA_3.HTML - MindAR: Target entita (a-entity[mindar-image-target]) STÁLE NENALEZENA po startu MindAR. Zkontroluj HTML strukturu a časování.");
            }

        } catch (e) {
            console.error("SCENA_3.HTML: Chyba při startu MindAR systému nebo nastavování listenerů:", e);
        }
    } else {
        console.error("SCENA_3.HTML: MindAR systém ('mindar-image-system') STÁLE nebyl nalezen na a-scene komponentě i po události 'loaded'.");
    }
}

window.onload = function() {
    enableCamera(); // Povol kameru
    const sceneEl = document.querySelector('a-scene');
    if (sceneEl) {
        if (sceneEl.hasLoaded) { // Pokud je scéna už načtená (což by po window.onload měla být)
            console.log("SCENA_3.HTML (onload): Scéna již načtena, spouštím inicializaci AR a gamifikace.");
            initializeArAndGamification();
        } else {
            console.log("SCENA_3.HTML (onload): Scéna se ještě načítá, přidávám listener 'loaded'.");
            sceneEl.addEventListener('loaded', initializeArAndGamification, { once: true }); // { once: true } zajistí, že se listener spustí jen jednou
        }
    } else {
        console.error("SCENA_3.HTML (onload): A-Frame scéna (<a-scene>) nenalezena.");
    }
};
</script>
</body>
</html>
